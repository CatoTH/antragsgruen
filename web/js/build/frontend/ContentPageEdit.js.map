{"version":3,"sources":["frontend/ContentPageEdit.ts"],"names":["ContentPageEdit","$form","this","on","e","preventDefault","$textSaver","find","$textHolder","$editCaller","$contentSettings","$downloadableFiles","editCalled","bind","addClass","save","length","initContentSettings","initDownloadableFiles","$","onSubmitDeleteForm","prototype","ev","_this","attr","editor","CKEDITOR","inline","scayt_sLang","removePlugins","extraPlugins","uploadUrl","data","filebrowserBrowseUrl","toolbarGroups","name","groups","evt","val","trigger","removeClass","showDownloadableFiles","$input","currentTarget","replace","$uploadLabel","path","split","filename","text","id","parents","first","delConfirm","bootbox","confirm","result","deleteDownloadableFile","deleteUrl","params","_csrf","post","ret","remove","children","alert","addUploadedFileCb","$el","append","hideDownloadableFiles","readUploadableFile","input","Promise","resolve","reject","reader","FileReader","onload","x","files","readAsDataURL","getData","prop","uploadedFile","_a","sent","window","setTimeout","destroy","document","title","last","location","href","confirmed","__t","exports"],"mappings":"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","file":"ContentPageEdit.js","sourcesContent":["import editor = CKEDITOR.editor;\n\nexport class ContentPageEdit {\n    private $editCaller: JQuery;\n    private $textHolder: JQuery;\n    private $textSaver: JQuery;\n    private $contentSettings: JQuery;\n    private $downloadableFiles: JQuery;\n    private editor: editor;\n\n    constructor(private $form: JQuery) {\n        $form.on(\"submit\", e => e.preventDefault()); // necessary for IE11\n        this.$textSaver = $form.find('.textSaver');\n        this.$textHolder = $form.find('.textHolder');\n        this.$editCaller = $form.find('.editCaller');\n        this.$contentSettings = $form.find('.contentSettingsToolbar');\n        this.$downloadableFiles = $form.find('.downloadableFiles');\n\n        this.$editCaller.on(\"click\", this.editCalled.bind(this));\n        this.$textSaver.addClass('hidden');\n        this.$textSaver.find('button').on(\"click\", this.save.bind(this));\n\n        if (this.$contentSettings.length > 0) {\n            this.initContentSettings();\n        }\n        if (this.$downloadableFiles.length > 0) {\n            this.initDownloadableFiles();\n        }\n\n        $(\".deletePageForm\").on(\"submit\", this.onSubmitDeleteForm.bind(this));\n    }\n\n    private editCalled(ev) {\n        ev.preventDefault();\n        this.$editCaller.addClass('hidden');\n        this.$textHolder.attr('contenteditable', \"true\");\n\n        this.editor = CKEDITOR.inline(this.$textHolder.attr('id'), {\n            scayt_sLang: 'de_DE',\n            removePlugins: 'lite,showbloks,about,selectall,forms',\n            extraPlugins: 'uploadimage',\n            uploadUrl: this.$form.data('upload-url'),\n            filebrowserBrowseUrl: this.$form.data('image-browse-url'),\n            //filebrowserUploadUrl: '/uploader/upload.php?type=Files',\n            toolbarGroups: [\n                {name: 'basicstyles', groups: ['basicstyles', 'cleanup']},\n                {name: 'colors'},\n                {name: 'links'},\n                {name: 'insert'},\n                {name: 'others'},\n                {name: 'tools'},\n                '/',\n                {name: 'styles'},\n                {name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi']}\n            ]\n        });\n        this.editor.on('fileUploadRequest', (evt) => {\n            evt.data['requestData']['_csrf'] = this.$form.find('> input[name=_csrf]').val();\n        });\n\n        this.$textHolder.trigger(\"focus\");\n        this.$textSaver.removeClass('hidden');\n        this.$contentSettings.removeClass('hidden');\n        this.showDownloadableFiles();\n    }\n\n    private initContentSettings() {\n        this.$contentSettings.find('input[name=url]').on('keyup change keypress', (ev) => {\n            let $input = $(ev.currentTarget);\n            $input.val(($input.val() as string).replace(/[^\\w_\\-,\\.äöüß]/, ''));\n        });\n    }\n\n    private initDownloadableFiles() {\n        const $uploadLabel = this.$downloadableFiles.find(\".uploadCol .text\");\n        this.$downloadableFiles.find(\"input[type=file]\").on(\"change\", () => {\n            const path = (this.$downloadableFiles.find(\"input[type=file]\").val() as string).split('\\\\');\n            const filename = path[path.length - 1];\n            $uploadLabel.text(filename);\n        });\n\n        this.$downloadableFiles.find(\".fileList\").on(\"click\", \".deleteFile\", (ev) => {\n            const id = $(ev.currentTarget).parents(\"li\").first().data(\"id\");\n            const delConfirm = this.$form.data(\"del-confirmation\");\n\n            bootbox.confirm(delConfirm, result => {\n                if (result) {\n                    this.deleteDownloadableFile(id);\n                }\n            });\n        });\n    }\n\n    private deleteDownloadableFile(id: string) {\n        const deleteUrl = this.$form.data(\"file-delete-url\");\n        const params = {\n\n            \"id\": id,\n            \"_csrf\": this.$form.find('> input[name=_csrf]').val(),\n        };\n\n        $.post(deleteUrl, params, (ret) => {\n            if (ret['success']) {\n                this.$downloadableFiles.find(\".fileList li[data-id=\" + id + \"]\").remove();\n\n                if (this.$downloadableFiles.find(\".fileList\").children().length === 0) {\n                    this.$downloadableFiles.find(\".none\").removeClass(\"hidden\");\n                }\n            } else {\n                alert(ret['message']);\n            }\n        });\n    }\n\n    private addUploadedFileCb(data) {\n        const $el = $('<li><a><span class=\"glyphicon glyphicon-download-alt\"></span> <span class=\"title\"></span></a>' +\n            '<button type=\"button\" class=\"btn btn-link deleteFile\"><span class=\"glyphicon glyphicon-trash\"></span></button></li>');\n        $el.find(\"a\").attr(\"href\", data['url']);\n        $el.find(\"a .title\").text(data['title']);\n        $el.attr(\"data-id\", data['id']);\n\n        this.$downloadableFiles.find(\"ul\").append($el);\n        this.$downloadableFiles.find(\".none\").addClass('hidden');\n    }\n\n    private hideDownloadableFiles() {\n        const hasFiles = (this.$downloadableFiles.find('ul li').length > 0);\n        if (!hasFiles) {\n            this.$downloadableFiles.addClass('hidden');\n        }\n        this.$downloadableFiles.find('.downloadableFilesUpload').addClass('hidden');\n        this.$downloadableFiles.find('#downloadableFileNew').val(\"\");\n        this.$downloadableFiles.find('#downloadableFileTitle').val(\"\");\n        this.$downloadableFiles.find(\".uploadCol .text\").text(this.$downloadableFiles.find(\".uploadCol .text\").data(\"title\"));\n    }\n\n    private showDownloadableFiles() {\n        this.$downloadableFiles.removeClass('hidden');\n        this.$downloadableFiles.find('.downloadableFilesUpload').removeClass('hidden');\n    }\n\n    private async readUploadableFile(input: HTMLInputElement): Promise<string> {\n        return new Promise((resolve, reject) => {\n            const reader = new FileReader();\n            reader.onload = function () {\n                const data = reader.result as string;\n                const x = data.split(\";base64,\");\n                if (x.length === 2) {\n                    resolve(x[1]);\n                } else {\n                    alert(\"Could not read the given file\");\n                    resolve(null);\n                }\n            };\n            if (input.files.length > 0) {\n                reader.readAsDataURL(input.files[0]);\n            } else {\n                resolve(null);\n            }\n        });\n    }\n\n    private async save(ev) {\n        ev.preventDefault();\n        let data = {\n            'data': this.editor.getData(),\n            '_csrf': this.$form.find('> input[name=_csrf]').val()\n        };\n        if (this.$contentSettings.length > 0) {\n            data['url'] = this.$contentSettings.find('input[name=url]').val();\n            data['title'] = this.$contentSettings.find('input[name=title]').val();\n            data['allConsultations'] = (this.$contentSettings.find('input[name=allConsultations]').prop('checked') ? 1 : 0);\n            data['inMenu'] = (this.$contentSettings.find('input[name=inMenu]').prop('checked') ? 1 : 0);\n        }\n        if (this.$downloadableFiles.length > 0) {\n            const input = this.$downloadableFiles.find(\"input[type=file]\")[0] as HTMLInputElement;\n            const uploadedFile = await this.readUploadableFile(input);\n\n            if (uploadedFile) {\n                const path = (this.$downloadableFiles.find(\"input[type=file]\").val() as string).split('\\\\');\n                const filename = path[path.length - 1];\n                data['uploadDownloadableFile'] = uploadedFile;\n                data['uploadDownloadableTitle'] = this.$downloadableFiles.find(\"#downloadableFileTitle\").val();\n                data['uploadDownloadableFilename'] = filename;\n            }\n        }\n\n        $.post(this.$form.attr('action'), data, (ret) => {\n            if (ret['success']) {\n                window.setTimeout(() => {\n                    this.editor.destroy();\n                }, 100);\n                this.$textSaver.addClass('hidden');\n                this.$textHolder.attr('contenteditable', 'false');\n                this.$editCaller.removeClass('hidden');\n                this.$contentSettings.addClass('hidden');\n\n                if (ret['title'] !== null) {\n                    $(\".pageTitle\").text(ret['title']);\n                    document.title = ret['title'];\n                    $(\"#mainmenu .page\" + ret['id']).text(ret['title']);\n                    $(\".breadcrumb\").children().last().text(ret['title']);\n                }\n\n                if (ret['uploadedFile']) {\n                    this.addUploadedFileCb(ret['uploadedFile']);\n                }\n                this.hideDownloadableFiles();\n\n                if (ret['message']) {\n                    alert(ret['message']);\n                }\n\n                if (ret['redirectTo']) {\n                    window.location.href = ret['redirectTo'];\n                }\n            } else {\n                alert('Something went wrong...');\n            }\n        })\n    }\n\n    private onSubmitDeleteForm(ev, data) {\n        if (data && typeof (data.confirmed) && data.confirmed === true) {\n            return;\n        }\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"delPageConfirm\"), function (result) {\n            if (result) {\n                $(\".deletePageForm\").trigger(\"submit\", {'confirmed': true});\n            }\n        });\n    }\n}\n"]}