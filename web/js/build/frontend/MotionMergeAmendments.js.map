{"version":3,"sources":["frontend/MotionMergeAmendments.ts"],"names":["AntragsgruenEditor","MotionMergeChangeActions","STATUS_ACCEPTED","STATUS_MODIFIED_ACCEPTED","STATUS_PROCESSED","STATUS_ADOPTED","STATUS_COMPLETED","AmendmentStatuses","init","statuses","versions","votingData","Object","keys","forEach","amendmentId","statusListeners","registerNewAmendment","status","version","console","log","deleteAmendment","getAmendmentStatus","getAmendmentVersion","getAmendmentVotingData","registerParagraph","paragraph","push","setStatus","onAmendmentStatusChanged","setVersion","onAmendmentVersionChanged","setVotesData","voteData","onAmendmentVotingChanged","getAmendmentIds","map","key","parseInt","getAllStatuses","getAllVersions","getAllVotingData","MotionMergeChangeTooltip","constructor","$element","mouseX","mouseY","parent","this","positionX","positionY","popover","container","animation","trigger","placement","$popover","$","data","window","setTimeout","width","elTop","offset","top","elHeight","height","css","html","content","getContent","bind","find","on","ev","stopPropagation","removePopupIfInactive","$myEl","cid","isAppendedCollision","isModU","undefined","parents","first","addClass","__t","$el","attr","text","hasClass","accept","reject","nodeName","toLowerCase","$list","alert","is","length","destroy","affectedChangesets","performActionWithUI","action","scrollX","scrollY","saveEditorSnapshot","call","focusTextarea","scrollTo","each","i","el","onChanged","focusAtSameCid","removeClass","stale","$stale","remove","warn","e","MotionMergeAmendmentsTextarea","prepareText","$text","$this","appendHint","removeData","markupMovedParagraph","newText","texteditor","setData","unchangedText","normalizeHtml","getData","fire","addChangedListener","cb","changedListeners","_","msg","$node","paragraphNew","replace","initializeTooltips","$holder","$target","currentTarget","MotionMergeAmendments","activePopup","pageX","pageY","acceptAll","insertAccept","deleteAccept","rejectAll","insertReject","deleteReject","getUnchangedContent","setText","entities","ent","RegExp","$changedIndicator","hasChanged","$mergeActionHolder","hasChanges","$textarea","edit","getEditor","MotionMergeAmendmentsParagraph","draft","amendmentStaticData","hasUnsavedChanges","handledCollisions","sectionId","paragraphId","paragraphDraft","paragraphs","$changed","textarea","initButtons","initSetCollisionsAsHandled","initStatusWidget","element","amendmentParagraphData","amend","id","JSON","parse","stringify","para","doAfterAskIfChanged","bootbox","confirm","result","statusWidget","Vue","createApp","template","methods","getAllAmendmentData","getAmendmentData","setAmendmentActive","amendment","active","reloadText","update","eventData","op","onStatusUpdated","newStatus","indexOf","onVotingUpdated","onVersionUpdated","onAmendmentAdded","nameBase","idAdd","verstion","onAmendmentDeleted","filter","config","compilerOptions","whitespace","statusWidgetComponent","mount","$collision","$collisionHolder","children","preventDefault","amendments","amendmentData","url","get","collisions","str","getDraftData","amendmentToggles","unchanged","onDraftChanged","$form","paragraphsByTypeAndNo","document","getElementById","getAttribute","amendmentStatuses","amendmentVersions","amendmentVotingData","$para","currMouseX","offsetX","saveDraft","off","onLeavePage","initDraftSaving","initNewAmendmentAlert","initCheckBackendStatus","initRemovingSectionTexts","initProtocol","setDraftDate","date","$draftSavingPanel","hide","lang","formatted","Intl","DateTimeFormat","year","month","day","hour","minute","hour12","format","$checkbox","$section","prop","editor","val","onlyInput","par","protocolPublic","sections","removedSections","protocol","CKEDITOR","instances","paraId","isPublic","dataStr","setAttribute","ajax","type","public","_csrf","success","ret","Date","parId","error","initAutosavingDraft","$toggle","setInterval","localStorage","state","getItem","setItem","$newAmendmentAlert","alertAboutNewAmendment","title","$buttons","$newButton","scrollintoview","top_offset","append","amendmentIds","join","onReceivedBackendStatus","newAmendments","deletedAmendments","newAmendmentStaticData","newAmendmentStatus","typeId","paragraphNo","paraObj","paraAmendmentData"],"mappings":"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","file":"MotionMergeAmendments.js","sourcesContent":["import { AntragsgruenEditor } from \"../shared/AntragsgruenEditor\";\nimport { MotionMergeChangeActions } from '../shared/MotionMergeChangeActions';\nimport editor = CKEDITOR.editor;\nimport ClickEvent = JQuery.ClickEvent;\n\ndeclare let Vue: any;\n\nconst STATUS_ACCEPTED = 4;\nconst STATUS_MODIFIED_ACCEPTED = 6;\nconst STATUS_PROCESSED = 17;\nconst STATUS_ADOPTED = 8;\nconst STATUS_COMPLETED = 9;\n\ntype AMENDMENT_VERSION = string;\n\ninterface VotingData {\n    votesYes: number;\n    votesNo: number;\n    votesAbstention: number;\n    votesInvalid: number;\n    comment: string;\n}\n\nclass AmendmentStatuses {\n    private static statuses: { [amendmentId: number]: number };\n    private static versions: { [amendmentId: number]: AMENDMENT_VERSION };\n    private static votingData: { [amendmentId: number]: VotingData };\n    private static statusListeners: { [amendmentId: number]: MotionMergeAmendmentsParagraph[] } = {};\n\n    public static init(\n        statuses: { [amendmentId: number]: number },\n        versions: { [amendmentId: number]: AMENDMENT_VERSION },\n        votingData: { [amendmentId: number]: VotingData }\n    ) {\n        AmendmentStatuses.statuses = statuses;\n        AmendmentStatuses.versions = versions;\n        AmendmentStatuses.votingData = votingData;\n\n        Object.keys(statuses).forEach(amendmentId => {\n            AmendmentStatuses.statusListeners[amendmentId] = [];\n        });\n    }\n\n    public static registerNewAmendment(amendmentId: number, status: number, version: AMENDMENT_VERSION, votingData: VotingData) {\n        AmendmentStatuses.statuses[amendmentId] = status;\n        AmendmentStatuses.versions[amendmentId] = version;\n        AmendmentStatuses.votingData[amendmentId] = votingData;\n        AmendmentStatuses.statusListeners[amendmentId] = [];\n\n        console.log(\"registered new amendment status\", AmendmentStatuses.statuses, AmendmentStatuses.versions, AmendmentStatuses.votingData);\n    }\n\n    public static deleteAmendment(amendmentId: number) {\n        delete(AmendmentStatuses.statuses[amendmentId]);\n        delete(AmendmentStatuses.versions[amendmentId]);\n        delete(AmendmentStatuses.votingData[amendmentId]);\n    }\n\n    public static getAmendmentStatus(amendmentId: number): number {\n        return AmendmentStatuses.statuses[amendmentId];\n    }\n\n    public static getAmendmentVersion(amendmentId: number): AMENDMENT_VERSION {\n        return AmendmentStatuses.versions[amendmentId];\n    }\n\n    public static getAmendmentVotingData(amendmentId: number): VotingData {\n        return AmendmentStatuses.votingData[amendmentId];\n    }\n\n    public static registerParagraph(amendmentId: number, paragraph: MotionMergeAmendmentsParagraph) {\n        AmendmentStatuses.statusListeners[amendmentId].push(paragraph);\n    }\n\n    public static setStatus(amendmentId: number, status: number) {\n        AmendmentStatuses.statuses[amendmentId] = status;\n        AmendmentStatuses.statusListeners[amendmentId].forEach(paragraph => {\n            paragraph.onAmendmentStatusChanged(amendmentId, status);\n        });\n    }\n\n    public static setVersion(amendmentId: number, version: AMENDMENT_VERSION) {\n        AmendmentStatuses.versions[amendmentId] = version;\n        AmendmentStatuses.statusListeners[amendmentId].forEach(paragraph => {\n            paragraph.onAmendmentVersionChanged(amendmentId, version);\n        });\n    }\n\n    public static setVotesData(amendmentId: number, voteData: VotingData) {\n        AmendmentStatuses.votingData[amendmentId] = voteData;\n        AmendmentStatuses.statusListeners[amendmentId].forEach(paragraph => {\n            paragraph.onAmendmentVotingChanged(amendmentId, voteData);\n        });\n    }\n\n    public static getAmendmentIds(): number[] {\n        return Object.keys(AmendmentStatuses.statuses).map(key => parseInt(key, 10));\n    }\n\n    public static getAllStatuses(): { [amendmentId: number]: number } {\n        return AmendmentStatuses.statuses;\n    }\n\n    public static getAllVersions(): { [amendmentId: number]: AMENDMENT_VERSION } {\n        return AmendmentStatuses.versions;\n    }\n\n    public static getAllVotingData(): { [amendmentId: number]: VotingData } {\n        return AmendmentStatuses.votingData;\n    }\n}\n\nclass MotionMergeChangeTooltip {\n    constructor(private $element: JQuery, mouseX: number, mouseY: number, private parent: MotionMergeAmendmentsTextarea) {\n        let positionX: number = null,\n            positionY: number = null;\n        $element.popover({\n            'container': 'body',\n            'animation': false,\n            'trigger': 'manual',\n            'placement': function (popover) {\n                let $popover = $(<any>popover);\n                $popover.data(\"element\", $element);\n                window.setTimeout(() => {\n                    let width = $popover.width(),\n                        elTop = $element.offset().top,\n                        elHeight = $element.height();\n                    if (positionX === null && width > 0) {\n                        positionX = (mouseX - width / 2);\n                        positionY = mouseY + 10;\n                        if (positionY < (elTop + 19)) {\n                            positionY = elTop + 19;\n                        }\n                        if (positionY > elTop + elHeight) {\n                            positionY = elTop + elHeight;\n                        }\n                    }\n                    $popover.css(\"left\", positionX + \"px\");\n                    $popover.css(\"top\", positionY + \"px\");\n                }, 1);\n                return \"bottom\";\n            },\n            'html': true,\n            'content': this.getContent.bind(this)\n        });\n\n        $element.popover('show');\n        let $popover: JQuery = $element.find(\"> .popover\");\n        $popover.on(\"mousemove\", (ev) => {\n            ev.stopPropagation();\n        });\n        window.setTimeout(this.removePopupIfInactive.bind(this), 1000);\n    }\n\n    private getContent() {\n        let $myEl: JQuery = this.$element,\n            html,\n            cid = $myEl.data(\"cid\"),\n            isAppendedCollision = ($myEl.data(\"appended-collision\") === 1 || $myEl.parent().data(\"appended-collision\") === 1),\n            isModU = $myEl.data(\"is-modu\") === 1;\n        if (cid == undefined) {\n            cid = $myEl.parent().data(\"cid\");\n        }\n        $myEl.parents(\".texteditor\").first().find(\"[data-cid=\" + cid + \"]\").addClass(\"hover\");\n\n        html = '';\n        if (isAppendedCollision) {\n            html += '<div class=\"mergingPopoverCollisionHint\">⚠️ ' + __t(\"merge\", \"mergedCollisionHint\") + '</div>';\n        }\n        html += '<div class=\"mergingPopoverButtons\">';\n        html += '<button type=\"button\" class=\"accept btn btn-sm btn-default\"></button>';\n        html += '<button type=\"button\" class=\"reject btn btn-sm btn-default\"></button>';\n        html += '<a href=\"#\" class=\"btn btn-small btn-default opener\" target=\"_blank\"><span class=\"glyphicon glyphicon-new-window\"></span></a>';\n        html += '<div class=\"initiator\" style=\"font-size: 0.8em;\"></div>';\n        html += '</div>';\n        let $el: JQuery = $(html);\n        $el.find(\".opener\").attr(\"href\", $myEl.data(\"link\")).attr(\"title\", __t(\"merge\", \"title_open_in_blank\"));\n        if (isModU) {\n            $el.find(\".initiator\").text(__t(\"merge\", \"modU\"));\n        } else {\n            $el.find(\".initiator\").text(__t(\"merge\", \"initiated_by\") + \": \" + $myEl.data(\"username\"));\n        }\n        if ($myEl.hasClass(\"ice-ins\")) {\n            $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).on(\"click\", this.accept.bind(this));\n            $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).on(\"click\", this.reject.bind(this));\n        } else if ($myEl.hasClass(\"ice-del\")) {\n            $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).on(\"click\", this.accept.bind(this));\n            $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).on(\"click\", this.reject.bind(this));\n        } else if ($myEl[0].nodeName.toLowerCase() == 'li') {\n            let $list = $myEl.parent();\n            if ($list.hasClass(\"ice-ins\")) {\n                $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).on(\"click\", this.accept.bind(this));\n                $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).on(\"click\", this.reject.bind(this));\n            } else if ($list.hasClass(\"ice-del\")) {\n                $el.find(\"button.accept\").text(__t(\"merge\", \"change_accept\")).on(\"click\", this.accept.bind(this));\n                $el.find(\"button.reject\").text(__t(\"merge\", \"change_reject\")).on(\"click\", this.reject.bind(this));\n            } else {\n                console.log(\"unknown\", $list);\n            }\n        } else {\n            console.log(\"unknown\", $myEl);\n            alert(\"unknown\");\n        }\n        return $el;\n    }\n\n    private removePopupIfInactive() {\n        if (this.$element.is(\":hover\")) {\n            return window.setTimeout(this.removePopupIfInactive.bind(this), 1000);\n        }\n        if ($(\"body\").find(\".popover:hover\").length > 0) {\n            return window.setTimeout(this.removePopupIfInactive.bind(this), 1000);\n        }\n        this.destroy();\n    }\n\n    private affectedChangesets() {\n        let cid = this.$element.data(\"cid\");\n        if (cid == undefined) {\n            cid = this.$element.parent().data(\"cid\");\n        }\n        return this.$element.parents(\".texteditor\").find(\"[data-cid=\" + cid + \"]\");\n    }\n\n    private performActionWithUI(action) {\n        let scrollX = window.scrollX,\n            scrollY = window.scrollY;\n\n        this.parent.saveEditorSnapshot();\n        this.destroy();\n        action.call(this);\n        this.parent.focusTextarea();\n\n        window.scrollTo(scrollX, scrollY);\n    }\n\n    private accept() {\n        this.performActionWithUI(() => {\n            this.affectedChangesets().each((i, el) => {\n                MotionMergeChangeActions.accept(el, () => {\n                    this.parent.onChanged();\n                });\n            });\n        });\n    }\n\n    private reject() {\n        this.performActionWithUI(() => {\n            this.affectedChangesets().each((i, el) => {\n                MotionMergeChangeActions.reject(el, () => {\n                    this.parent.onChanged();\n                });\n            });\n        });\n    }\n\n    public destroy() {\n        this.$element.popover(\"hide\").popover(\"destroy\");\n\n        let cid = this.$element.data(\"cid\");\n        if (cid == undefined) {\n            cid = this.$element.parent().data(\"cid\");\n        }\n\n        let focusAtSameCid = false;\n        this.$element.parents(\".texteditor\").first().find(\"[data-cid=\" + cid + \"]\").each((i, el) => {\n            if ($(el).is(\":hover\")) {\n                focusAtSameCid = true;\n            }\n        });\n        if (!focusAtSameCid) {\n            this.$element.parents(\".texteditor\").first().find(\"[data-cid=\" + cid + \"]\").removeClass(\"hover\");\n        }\n\n        try {\n            // Remove stale objects that were not removed correctly previously\n            $(\".popover\").each((i, stale) => {\n                const $stale = $(stale);\n                if (!$stale.data(\"element\").is(\":hover\")) {\n                    $stale.popover(\"hide\").popover(\"destroy\");\n                    $stale.remove();\n                    console.warn(\"Removed stale window: \", $stale);\n                }\n            });\n        } catch (e) {\n        }\n    }\n}\n\nclass MotionMergeAmendmentsTextarea {\n    private texteditor: editor;\n    private unchangedText: string = null;\n    private hasChanged: boolean = false;\n    private changedListeners: { (): void }[] = [];\n\n    private prepareText(html: string) {\n        let $text: JQuery = $('<div>' + html + '</div>');\n\n        // Move the amendment-Data from OL's and UL's to their list items\n        $text.find(\"ul.appendHint, ol.appendHint\").each((i, el) => {\n            let $this: JQuery = $(el),\n                appendHint = $this.data(\"append-hint\");\n            $this.find(\"> li\").addClass(\"appendHint\").attr(\"data-append-hint\", appendHint)\n                .attr(\"data-link\", $this.data(\"link\"))\n                .attr(\"data-username\", $this.data(\"username\"));\n            $this.removeClass(\"appendHint\").removeData(\"append-hint\");\n        });\n\n        // Remove double markup\n        $text.find(\".moved .moved\").removeClass('moved');\n        $text.find(\".moved\").each(this.markupMovedParagraph.bind(this));\n\n        let newText = $text.html();\n        this.texteditor.setData(newText);\n        this.unchangedText = this.normalizeHtml(this.texteditor.getData());\n        this.texteditor.fire('saveSnapshot');\n        this.onChanged();\n    }\n\n    public addChangedListener(cb: () => void) {\n        this.changedListeners.push(cb);\n    }\n\n    private markupMovedParagraph(_, el) {\n        let $node = $(el),\n            paragraphNew = $node.data('moving-partner-paragraph'),\n            msg: string;\n\n        if ($node.hasClass('inserted')) {\n            msg = __t('std', 'moved_paragraph_from');\n        } else {\n            msg = __t('std', 'moved_paragraph_to');\n        }\n        msg = msg.replace(/##PARA##/, (paragraphNew + 1));\n\n        if ($node[0].nodeName === 'LI') {\n            $node = $node.parent();\n        }\n\n        $node.attr(\"data-moving-msg\", msg);\n    }\n\n    private initializeTooltips() {\n        this.$holder.on(\"mouseover\", \".appendHint\", (ev) => {\n            const $target = $(ev.currentTarget);\n            if ($target.parents('.paragraphWrapper').first().find('.amendmentStatus.open').length > 0) {\n                return;\n            }\n            if (MotionMergeAmendments.activePopup) {\n                MotionMergeAmendments.activePopup.destroy();\n            }\n            MotionMergeAmendments.activePopup = new MotionMergeChangeTooltip($target, ev.pageX, ev.pageY, this);\n        });\n    }\n\n\n    public acceptAll() {\n        this.saveEditorSnapshot();\n        this.$holder.find(\".ice-ins\").each((i, el) => {\n            MotionMergeChangeActions.insertAccept(el);\n        });\n        this.$holder.find(\".ice-del\").each((i, el) => {\n            MotionMergeChangeActions.deleteAccept(el, false);\n        });\n        this.onChanged();\n        window.setTimeout(() => {\n            // Wait for animation -> remove \"all dropdown\"\n            this.onChanged();\n            this.saveEditorSnapshot();\n        }, 1000);\n    }\n\n    public rejectAll() {\n        this.saveEditorSnapshot();\n        this.$holder.find(\".ice-ins\").each((i, el) => {\n            MotionMergeChangeActions.insertReject($(el));\n        });\n        this.$holder.find(\".ice-del\").each((i, el) => {\n            MotionMergeChangeActions.deleteReject($(el));\n        });\n        this.onChanged();\n        window.setTimeout(() => {\n            // Wait for animation -> remove \"all dropdown\"\n            this.onChanged();\n            this.saveEditorSnapshot();\n        }, 1000);\n    }\n\n    public saveEditorSnapshot() {\n        this.texteditor.fire('saveSnapshot');\n    }\n\n    public focusTextarea() {\n        //this.$holder.find(\".texteditor\").focus();\n        // This lead to strange cursor behavior, e.g. when removing a colliding paragraph\n    }\n\n    public getContent(): string {\n        return this.texteditor.getData();\n    }\n\n    public getUnchangedContent(): string {\n        return this.unchangedText;\n    }\n\n    public setText(html: string) {\n        this.prepareText(html);\n        this.initializeTooltips();\n    }\n\n    private normalizeHtml(html: string) {\n        const entities = {\n            '&nbsp;': ' ',\n            '&ndash;': '-',\n            '&auml;': 'ä',\n            '&ouml;': 'ö',\n            '&uuml;': 'ü',\n            '&Auml;': 'Ä',\n            '&Ouml;': 'Ö',\n            '&Uuml;': 'Ü',\n            '&szlig;': 'ß',\n            '&bdquo;': '„',\n            '&ldquo;': '“',\n            '&bull;': '•',\n            '&sect;': '§',\n            '&eacute;': 'é',\n            '&rsquo;': '’',\n            '&euro;': '€'\n        };\n        Object.keys(entities).forEach(ent => {\n            html = html.replace(new RegExp(ent, 'g'), entities[ent]);\n        });\n\n        return html.replace(/\\s+</g, '<').replace(/>\\s+/g, '>')\n            .replace(/<[^>]*ice-ins[^>]*>/g, 'ice-ins') // make sure accepted insertions are still recognized as change\n            .replace(/<ins[^>]*>/g, 'ice-ins')\n            .replace(/<[^>]*>/g, '');\n    }\n\n    public onChanged() {\n        if (this.normalizeHtml(this.texteditor.getData()) === this.unchangedText) {\n            this.$changedIndicator.addClass(\"unchanged\");\n            this.hasChanged = false;\n        } else {\n            this.$changedIndicator.removeClass(\"unchanged\");\n            this.hasChanged = true;\n        }\n        if (this.$holder.find(\".ice-ins\").length > 0 || this.$holder.find(\".ice-del\").length > 0) {\n            this.$mergeActionHolder.removeClass(\"hidden\");\n        } else {\n            this.$mergeActionHolder.addClass(\"hidden\");\n        }\n        this.changedListeners.forEach(cb => cb());\n    }\n\n    public hasChanges(): boolean {\n        return this.hasChanged;\n    }\n\n    constructor(private $holder: JQuery, private $changedIndicator: JQuery, private $mergeActionHolder: JQuery) {\n        let $textarea = $holder.find(\".texteditor\");\n        let edit = new AntragsgruenEditor($textarea.attr(\"id\"));\n        this.texteditor = edit.getEditor();\n\n        this.setText(this.texteditor.getData());\n\n        if ($holder.data(\"unchanged\")) {\n            this.unchangedText = $holder.data(\"unchanged\");\n            this.onChanged();\n        }\n\n        this.texteditor.on('change', this.onChanged.bind(this));\n    }\n}\n\nclass MotionMergeAmendmentsParagraph {\n    public sectionId: number;\n    public paragraphId: number;\n    public textarea: MotionMergeAmendmentsTextarea;\n    public hasUnsavedChanges = false;\n    public handledCollisions: number[] = [];\n    public statusWidget: any;\n    public statusWidgetComponent: any;\n\n    constructor(private $holder: JQuery, draft: any, amendmentStaticData: any) {\n        this.sectionId = parseInt($holder.data('sectionId'));\n        this.paragraphId = parseInt($holder.data('paragraphId'));\n\n        const paragraphDraft = draft.paragraphs && draft.paragraphs[this.sectionId + \"_\" + this.paragraphId] ? draft.paragraphs[this.sectionId + \"_\" + this.paragraphId] : null;\n        if (paragraphDraft.handledCollisions) {\n            this.handledCollisions = paragraphDraft.handledCollisions;\n        }\n\n        const $textarea = $holder.find(\".wysiwyg-textarea\");\n        const $changed = $holder.find(\".changedIndicator\");\n        const $mergeActionHolder = $holder.find(\".mergeActionHolder\");\n        this.textarea = new MotionMergeAmendmentsTextarea($textarea, $changed, $mergeActionHolder);\n\n        this.initButtons();\n        this.initSetCollisionsAsHandled();\n        this.initStatusWidget(amendmentStaticData);\n\n        $holder.find(\".amendmentStatus\").each((i: number, element) => {\n            AmendmentStatuses.registerParagraph($(element).data(\"amendment-id\"), this);\n        });\n\n        this.textarea.addChangedListener(() => this.hasUnsavedChanges = true);\n    }\n\n    private initStatusWidget(amendmentStaticData: any) {\n        const amendmentParagraphData = this.$holder.find(\".changeToolbar .statuses\").data(\"amendments\");\n        for (let i = 0; i < amendmentParagraphData.length; i++) {\n            const amendmentId = amendmentParagraphData[i].amendmentId;\n            amendmentParagraphData[i]['amendment'] = amendmentStaticData.find(amend => amend.id === amendmentId);\n            amendmentParagraphData[i]['status'] = AmendmentStatuses.getAmendmentStatus(amendmentId);\n            amendmentParagraphData[i]['version'] = AmendmentStatuses.getAmendmentVersion(amendmentId);\n            amendmentParagraphData[i]['votingData'] = JSON.parse(JSON.stringify(AmendmentStatuses.getAmendmentVotingData(amendmentId)));\n        }\n\n        const para = this;\n\n        const doAfterAskIfChanged = (cb) => {\n            if (para.textarea.hasChanges()) {\n                bootbox.confirm(__t('merge', 'reloadParagraph'), (result) => {\n                    if (result) {\n                        cb();\n                    }\n                });\n            } else {\n                cb();\n            }\n        };\n\n        para.statusWidget = Vue.createApp({\n            template: `\n                <div class=\"statuses\">\n                    <paragraph-amendment-settings v-for=\"data in amendmentParagraphData\"\n                                                  v-bind:amendment=\"data.amendment\"\n                                                  v-bind:nameBase=\"data.nameBase\"\n                                                  v-bind:idAdd=\"data.idAdd\"\n                                                  v-bind:active=\"data.active\"\n                                                  v-bind:status=\"data.status\"\n                                                  v-bind:version=\"data.version\"\n                                                  v-bind:votingData=\"data.votingData\"\n                                                  v-on:update=\"update($event)\"\n                    ></paragraph-amendment-settings>\n                </div>`,\n            data() { return {\n                amendmentParagraphData,\n            } },\n            methods: {\n                getAllAmendmentData() {\n                    return this.amendmentParagraphData;\n                },\n                getAmendmentData(amendmentId) {\n                    for (let i = 0; i < this.amendmentParagraphData.length; i++) {\n                        if (this.amendmentParagraphData[i].amendmentId == amendmentId) {\n                            return this.amendmentParagraphData[i];\n                        }\n                    }\n                    return null;\n                },\n                setAmendmentActive(amendment, active) {\n                    amendment.active = active;\n                    para.reloadText();\n                },\n                update(eventData) {\n                    // Events coming from the widget directly\n                    const op = eventData[0];\n                    const amendmentId = eventData[1],\n                        amendment = this.getAmendmentData(amendmentId);\n                    if (!amendment) {\n                        return;\n                    }\n                    switch (op) {\n                        case 'set-active':\n                            doAfterAskIfChanged(() => this.setAmendmentActive(amendment, eventData[2]));\n                            break;\n                        case 'set-status':\n                            AmendmentStatuses.setStatus(amendmentId, parseInt(eventData[2]));\n                            break;\n                        case 'set-votes':\n                            AmendmentStatuses.setVotesData(amendmentId, eventData[2]);\n                            break;\n                        case 'set-version':\n                            console.log(\"set version\", eventData[2]);\n                            doAfterAskIfChanged(() => {\n                                // Do this no matter what - not only if it's unchanged\n                                AmendmentStatuses.setVersion(amendmentId, eventData[2]);\n                                para.reloadText();\n                            });\n                            break;\n                    }\n                    para.hasUnsavedChanges = true;\n                },\n                onStatusUpdated(amendmentId, newStatus) {\n                    const amendment = this.getAmendmentData(amendmentId);\n                    if (amendment) {\n                        amendment.status = newStatus;\n                        if (!para.textarea.hasChanges()) {\n                            amendment.active = ([STATUS_ACCEPTED, STATUS_MODIFIED_ACCEPTED, STATUS_PROCESSED, STATUS_ADOPTED, STATUS_COMPLETED].indexOf(newStatus) !== -1);\n                            para.reloadText();\n                        }\n                    }\n                },\n                onVotingUpdated(amendmentId, votingData) {\n                    const amendment = this.getAmendmentData(amendmentId);\n                    if (amendment) {\n                        amendment.votingData = votingData;\n                    }\n                },\n                onVersionUpdated(amendmentId, version) {\n                    const amendment = this.getAmendmentData(amendmentId);\n                    if (amendment) {\n                        amendment.version = version;\n                        if (!para.textarea.hasChanges()) {\n                            para.reloadText();\n                        }\n                    }\n                },\n                onAmendmentAdded(amendment, nameBase, idAdd, active, status, verstion, votingData) {\n                    this.amendmentParagraphData.push({\n                        amendmentId: amendment.id,\n                        amendment, nameBase, idAdd, active, status, verstion, votingData\n                    });\n                },\n                onAmendmentDeleted(amendmentId) {\n                    this.amendmentParagraphData = this.amendmentParagraphData.filter(amend => amend.amendmentId != amendmentId);\n                }\n            }\n        });\n\n        para.statusWidget.config.compilerOptions.whitespace = 'condense';\n        window['__initVueComponents'](para.statusWidget, 'merging');\n        para.statusWidgetComponent = para.statusWidget.mount(this.$holder.find(\".changeToolbar .statuses\")[0]);\n    }\n\n    public onAmendmentVersionChanged(amendmentId: number, version: string) {\n        this.statusWidgetComponent.onVersionUpdated(amendmentId, version);\n    }\n\n    public onAmendmentVotingChanged(amendmentId: number, votingData: VotingData) {\n        this.statusWidgetComponent.onVotingUpdated(amendmentId, votingData);\n    }\n\n    public onAmendmentStatusChanged(amendmentId: number, status: number) {\n        this.statusWidgetComponent.onStatusUpdated(amendmentId, status);\n    }\n\n    public onAmendmentAdded(amendment, nameBase, idAdd, active, status, verstion, votingData) {\n        this.statusWidgetComponent.onAmendmentAdded(amendment, nameBase, idAdd, active, status, verstion, votingData);\n    }\n\n    public onAmendmentDeleted(amendmentId) {\n        this.statusWidgetComponent.onAmendmentDeleted(amendmentId);\n    }\n\n    private initSetCollisionsAsHandled() {\n        this.$holder.on(\"click\", \"button.hideCollision\", (ev: ClickEvent) => {\n            const $collision = $(ev.currentTarget).parents(\".collidingParagraph\").first();\n            const amendmentId = parseInt($collision.data(\"amendment-id\"), 10);\n            const $collisionHolder = $collision.parent();\n            $collision.remove();\n            if ($collisionHolder.children().length === 0) {\n                this.$holder.removeClass(\"hasCollisions\");\n            }\n            this.handledCollisions.push(amendmentId);\n            this.hasUnsavedChanges = true;\n        });\n    }\n\n    private initButtons() {\n        this.$holder.find(\".mergeActionHolder .acceptAll\").on(\"click\", ev => {\n            ev.preventDefault();\n            this.textarea.acceptAll();\n            this.hasUnsavedChanges = true;\n        });\n\n        this.$holder.find(\".mergeActionHolder .rejectAll\").on(\"click\", ev => {\n            ev.preventDefault();\n            this.textarea.rejectAll();\n            this.hasUnsavedChanges = true;\n        });\n    }\n\n    private reloadText() {\n        const amendments = this.statusWidgetComponent.getAllAmendmentData()\n            .filter(amendmentData => amendmentData.active)\n            .map(amendmentData => {\n                return {\n                    id: amendmentData.amendmentId,\n                    version: AmendmentStatuses.getAmendmentVersion(amendmentData.amendmentId),\n                }\n            });\n        const url = this.$holder.data(\"reload-url\").replace('DUMMY', JSON.stringify(amendments));\n        $.get(url, (data) => {\n            this.textarea.setText(data.text);\n\n            let collisions = '';\n            data.collisions.forEach(str => {\n                collisions += str;\n            });\n\n            this.$holder.find(\".collisionsHolder\").html(collisions);\n            if (data.collisions.length > 0) {\n                this.$holder.addClass(\"hasCollisions\");\n            } else {\n                this.$holder.removeClass(\"hasCollisions\");\n            }\n            this.handledCollisions = [];\n            this.hasUnsavedChanges = true;\n        });\n    }\n\n    public getDraftData() {\n        const amendmentToggles = this.statusWidgetComponent.getAllAmendmentData()\n            .filter(amendmentData => amendmentData.active)\n            .map(amendmentData => amendmentData.amendmentId);\n        return {\n            amendmentToggles,\n            text: this.textarea.getContent(),\n            unchanged: this.textarea.getUnchangedContent(),\n            handledCollisions: this.handledCollisions,\n        };\n    }\n\n    public onDraftChanged() {\n        this.hasUnsavedChanges = false;\n    }\n}\n\n/**\n * Singleton object\n */\nexport class MotionMergeAmendments {\n    public static activePopup: MotionMergeChangeTooltip = null;\n    public static currMouseX: number = null;\n    public static $form;\n\n    public $draftSavingPanel: JQuery;\n    public $newAmendmentAlert: JQuery;\n    private paragraphsByTypeAndNo: {[typeAndPara: string]: MotionMergeAmendmentsParagraph} = {};\n    private hasUnsavedChanges = false;\n\n    constructor($form: JQuery) {\n        MotionMergeAmendments.$form = $form;\n\n        const draft = JSON.parse(document.getElementById('mergeDraft').getAttribute('value'));\n        AmendmentStatuses.init(draft.amendmentStatuses, draft.amendmentVersions, draft.amendmentVotingData);\n\n        const amendmentStaticData = $form.data('amendment-static-data');\n\n        $(\".paragraphWrapper\").each((i, el) => {\n            const $para = $(el);\n            const sectionId = $para.data(\"section-id\");\n            const paragraphId = $para.data(\"paragraph-id\");\n            $para.find(\".wysiwyg-textarea\").on(\"mousemove\", (ev) => {\n                MotionMergeAmendments.currMouseX = ev.offsetX;\n            });\n\n            this.paragraphsByTypeAndNo[sectionId + '_' + paragraphId] = new MotionMergeAmendmentsParagraph($para, draft, amendmentStaticData);\n        });\n\n        MotionMergeAmendments.$form.on(\"submit\", () => {\n            this.hasUnsavedChanges = true; // Enforce that the INPUT field is set\n            this.saveDraft(true);\n            $(window).off(\"beforeunload\", MotionMergeAmendments.onLeavePage);\n        });\n        $(window).on(\"beforeunload\", MotionMergeAmendments.onLeavePage);\n\n        this.initDraftSaving();\n        this.initNewAmendmentAlert();\n        this.initCheckBackendStatus();\n        this.initRemovingSectionTexts();\n        this.initProtocol();\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    private setDraftDate(date: Date) {\n        this.$draftSavingPanel.find(\".lastSaved .none\").hide();\n\n        let options: Intl.DateTimeFormatOptions = {\n                year: 'numeric', month: 'numeric', day: 'numeric',\n                hour: 'numeric', minute: 'numeric',\n                hour12: false\n            },\n            lang: string = $(\"html\").attr(\"lang\"),\n            formatted = new Intl.DateTimeFormat(lang, options).format(date);\n\n        this.$draftSavingPanel.find(\".lastSaved .value\").text(formatted);\n    }\n\n    private initRemovingSectionTexts() {\n        MotionMergeAmendments.$form.find(\".removeSection input[type=checkbox]\").on(\"change\", ev => {\n            const $checkbox = $(ev.currentTarget);\n            const $section = $checkbox.parents(\".section\").first();\n            if ($checkbox.prop(\"checked\")) {\n                $section.find(\".sectionHolder\").addClass(\"hidden\");\n            } else {\n                $section.find(\".sectionHolder\").removeClass(\"hidden\");\n            }\n        }).trigger(\"change\");\n    }\n\n    private initProtocol() {\n        const $textarea = $(\"#protocol_text_wysiwyg\");\n        $textarea.attr(\"contenteditable\", \"true\");\n        const ckeditor = new AntragsgruenEditor($textarea.attr(\"id\"));\n        const editor = ckeditor.getEditor();\n\n        $textarea.parents(\"form\").on(\"submit\", () => {\n            $textarea.parent().find(\"textarea\").val(editor.getData());\n        });\n    }\n\n    private saveDraft(onlyInput = false) {\n        if (Object.keys(this.paragraphsByTypeAndNo).map(id => this.paragraphsByTypeAndNo[id])\n            .filter(par => par.hasUnsavedChanges).length === 0 && !this.hasUnsavedChanges) {\n            return;\n        }\n\n        console.log(\"Has unsaved changes\");\n\n        const protocolPublic = $(\"input[name=protocol_public]:checked\").val() as string;\n        const data = {\n            \"amendmentStatuses\": AmendmentStatuses.getAllStatuses(),\n            \"amendmentVersions\": AmendmentStatuses.getAllVersions(),\n            \"amendmentVotingData\": AmendmentStatuses.getAllVotingData(),\n            \"paragraphs\": {},\n            \"sections\": {},\n            \"removedSections\": [],\n            \"protocol\": CKEDITOR.instances['protocol_text_wysiwyg'].getData(),\n            \"protocolPublic\": parseInt(protocolPublic) === 1,\n        };\n        $(\".sectionType0\").each((i, el) => {\n            const $section = $(el),\n                sectionId = $section.data(\"section-id\");\n            data.sections[sectionId] = $section.find(\".form-control\").val();\n        });\n        MotionMergeAmendments.$form.find(\".removeSection input[type=checkbox]:checked\").each((i, el) => {\n            data.removedSections.push(parseInt($(el).val() as string));\n        });\n\n        Object.keys(this.paragraphsByTypeAndNo).forEach(paraId => {\n            data.paragraphs[paraId] = this.paragraphsByTypeAndNo[paraId].getDraftData();\n        });\n        let isPublic: boolean = this.$draftSavingPanel.find('input[name=public]').prop('checked');\n\n        const dataStr = JSON.stringify(data);\n        document.getElementById('mergeDraft').setAttribute('value', dataStr);\n\n        if (!onlyInput) {\n            $.ajax({\n                type: \"POST\",\n                url: MotionMergeAmendments.$form.data('draftSavingUrl'),\n                data: {\n                    'public': (isPublic ? 1 : 0),\n                    data: dataStr,\n                    '_csrf': MotionMergeAmendments.$form.find('> input[name=_csrf]').val()\n                },\n                success: (ret) => {\n                    if (ret['success']) {\n                        this.$draftSavingPanel.find('.savingError').addClass('hidden');\n                        this.setDraftDate(new Date(ret['date']));\n                        if (isPublic) {\n                            MotionMergeAmendments.$form.find('.publicLink').removeClass('hidden');\n                        } else {\n                            MotionMergeAmendments.$form.find('.publicLink').addClass('hidden');\n                        }\n                    } else {\n                        this.$draftSavingPanel.find('.savingError').removeClass('hidden');\n                        this.$draftSavingPanel.find('.savingError .errorNetwork').addClass('hidden');\n                        this.$draftSavingPanel.find('.savingError .errorHolder').text(ret['error']).removeClass('hidden');\n                    }\n\n                    Object.keys(this.paragraphsByTypeAndNo).forEach(parId => this.paragraphsByTypeAndNo[parId].onDraftChanged());\n                    this.hasUnsavedChanges = false;\n                },\n                error: () => {\n                    this.$draftSavingPanel.find('.savingError').removeClass('hidden');\n                    this.$draftSavingPanel.find('.savingError .errorNetwork').removeClass('hidden');\n                    this.$draftSavingPanel.find('.savingError .errorHolder').text('').addClass('hidden');\n                }\n            });\n        }\n    }\n\n    private initAutosavingDraft() {\n        let $toggle: JQuery = this.$draftSavingPanel.find('input[name=autosave]');\n\n        window.setInterval(() => {\n            if ($toggle.prop('checked')) {\n                this.saveDraft(false);\n            }\n        }, 5000);\n\n        if (localStorage) {\n            let state = localStorage.getItem('merging-draft-auto-save');\n            if (state !== null) {\n                $toggle.prop('checked', (state == '1'));\n            }\n        }\n        $toggle.on(\"change\", () => {\n            let active: boolean = $toggle.prop('checked');\n            if (localStorage) {\n                localStorage.setItem('merging-draft-auto-save', (active ? '1' : '0'));\n            }\n        }).trigger('change');\n    }\n\n    private initDraftSaving() {\n        this.$draftSavingPanel = MotionMergeAmendments.$form.find('#draftSavingPanel');\n        this.$draftSavingPanel.find('.saveDraft').on('click', () => {\n            this.hasUnsavedChanges = true;\n            this.saveDraft(false);\n        });\n        this.$draftSavingPanel.find('input[name=public]').on('change', () => {\n            this.hasUnsavedChanges = true;\n            this.saveDraft(false)\n        });\n        this.initAutosavingDraft();\n\n        if (this.$draftSavingPanel.data(\"resumed-date\")) {\n            let date = new Date(this.$draftSavingPanel.data(\"resumed-date\"));\n            this.setDraftDate(date);\n        }\n\n        $(\".sectionType0\").on(\"change\", () => this.hasUnsavedChanges = true);\n\n        $(\"#yii-debug-toolbar\").remove();\n    }\n\n    private initNewAmendmentAlert() {\n        this.$newAmendmentAlert = MotionMergeAmendments.$form.find('#newAmendmentAlert');\n        this.$newAmendmentAlert.find('.closeLink').on('click', () => {\n            this.$newAmendmentAlert.find('.buttons').children().remove();\n            this.$newAmendmentAlert.removeClass('revealed');\n            window.setTimeout(() => {\n                this.$newAmendmentAlert.addClass('hidden');\n            }, 1000);\n        });\n    }\n\n    private alertAboutNewAmendment(amendmentId: number, title: string) {\n        const $buttons = this.$newAmendmentAlert.find('.buttons');\n        const $newButton = $('<button class=\"btn-link gotoAmendment\" type=\"button\"></button>').text(title);\n        $newButton.on('click', () => {\n            const $firstToggle = $(\".amendmentStatus\" + amendmentId).first();\n            const $paragraph = $firstToggle.parents('.paragraphWrapper');\n            $paragraph.scrollintoview({top_offset: -100});\n        });\n        $buttons.append($newButton);\n\n        if ($buttons.children().length > 1) {\n            this.$newAmendmentAlert.find('.message .one').addClass('hidden');\n            this.$newAmendmentAlert.find('.message .many').removeClass('hidden');\n        } else {\n            this.$newAmendmentAlert.find('.message .one').removeClass('hidden');\n            this.$newAmendmentAlert.find('.message .many').addClass('hidden');\n        }\n\n        if (this.$newAmendmentAlert.hasClass('hidden')) {\n            this.$newAmendmentAlert.removeClass('hidden');\n            window.setTimeout(() => {\n                this.$newAmendmentAlert.addClass('revealed');\n            }, 100);\n        }\n    }\n\n    private initCheckBackendStatus() {\n        window.setInterval(() => {\n            let url = MotionMergeAmendments.$form.data('checkStatusUrl');\n            const amendmentIds = AmendmentStatuses.getAmendmentIds();\n            url = url.replace(/AMENDMENTS/, amendmentIds.join(','));\n            $.get(url, data => {\n                if (data['success']) {\n                    this.onReceivedBackendStatus(data['new'], data['deleted']);\n                } else {\n                    console.warn(data);\n                }\n            });\n        }, 3000);\n    }\n\n    private onReceivedBackendStatus(newAmendments: any[], deletedAmendments: any[]) {\n        const newAmendmentStaticData = {},\n            newAmendmentStatus = {};\n        newAmendments['staticData'].forEach(amendmentData => {\n            const status = newAmendments['status'][amendmentData['id']];\n            newAmendmentStaticData[amendmentData['id']] = amendmentData;\n            newAmendmentStatus[amendmentData['id']] = status;\n\n            AmendmentStatuses.registerNewAmendment(amendmentData['id'], status['status'], status['version'], status['votingData']);\n\n            this.alertAboutNewAmendment(amendmentData['id'], amendmentData['titlePrefix']);\n        });\n\n        Object.keys(newAmendments['paragraphs']).forEach(typeId => {\n            Object.keys(newAmendments['paragraphs'][typeId]).forEach(paragraphNo => {\n                const paraObj = this.paragraphsByTypeAndNo[typeId + '_' + paragraphNo];\n                newAmendments['paragraphs'][typeId][paragraphNo].forEach(data => {\n                    const paraAmendmentData = newAmendmentStaticData[data.amendmentId];\n                    const status = newAmendmentStatus[data.amendmentId];\n                    paraObj.onAmendmentAdded(paraAmendmentData, data['nameBase'], data['idAdd'], data['active'], status['status'], status['version'], status['votingData'])\n                    AmendmentStatuses.registerParagraph(data.amendmentId, paraObj);\n                });\n            });\n        });\n\n        deletedAmendments.forEach(amendmentId => {\n            console.log(\"Removing amendment\", amendmentId);\n            AmendmentStatuses.deleteAmendment(amendmentId);\n\n            Object.keys(this.paragraphsByTypeAndNo).forEach(id => {\n                this.paragraphsByTypeAndNo[id].onAmendmentDeleted(amendmentId);\n            });\n        });\n    }\n}\n"]}