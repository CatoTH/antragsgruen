{"version":3,"sources":["frontend/MotionEditForm.ts"],"names":["DraftSavingEngine","AntragsgruenEditor","MotionEditForm","constructor","$form","this","hasChanged","$","datetimepicker","locale","attr","format","each","initWysiwyg","bind","initPlainTextFormGroup","$draftHint","draftMotionType","data","draftMotionId","on","ev","onSubmitCheck","error","checkMultipleTagsError","preventDefault","encouragement","getEncouragedFieldError","bootbox","dialog","title","field","message","buttons","submit","label","callback","append","trigger","fill","scrollintoview","top_offset","window","off","onLeavePage","result","find","$field","$label","length","text","val","trim","$group","removeClass","addClass","__t","i","el","$textarea","editor","parents","parent","getEditor","getData","hasClass","$fieldset","$input","maxLen","maxLenSoft","$warning","$submit","first","$currCounter","currLen","prop"],"mappings":"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","file":"MotionEditForm.js","sourcesContent":["import {DraftSavingEngine} from \"../shared/DraftSavingEngine\";\nimport {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\nimport SubmitEvent = JQuery.SubmitEvent;\n\nexport class MotionEditForm {\n    private hasChanged: boolean = false;\n\n    constructor(private $form: JQuery) {\n        $(\".input-group.date\").datetimepicker({\n            locale: $(\"html\").attr('lang'),\n            format: 'L'\n        });\n\n        $(\".wysiwyg-textarea\").each(this.initWysiwyg.bind(this));\n        $(\".form-group.plain-text\").each(this.initPlainTextFormGroup.bind(this));\n\n        let $draftHint = $(\"#draftHint\"),\n            draftMotionType = $draftHint.data(\"motion-type\"),\n            draftMotionId = $draftHint.data(\"motion-id\");\n\n        new DraftSavingEngine($form, $draftHint, \"motion_\" + draftMotionType + \"_\" + draftMotionId);\n\n        $form.on(\"submit\", (ev) => {\n            this.onSubmitCheck(ev, $form)\n        });\n    }\n\n    private onSubmitCheck(ev: SubmitEvent, $form: JQuery): void {\n        let error: boolean = false;\n        if (this.checkMultipleTagsError()) {\n            error = true;\n        }\n\n        if (error) {\n            ev.preventDefault();\n        } else {\n            const encouragement = this.getEncouragedFieldError($form);\n            if (encouragement) {\n                ev.preventDefault();\n\n                bootbox.dialog({\n                    title: encouragement.field.data('encouraged-title'),\n                    message: encouragement.field.data('encouraged-str'),\n                    buttons: {\n                        submit: {\n                            label: encouragement.field.data('encouraged-submit'),\n                            callback: function() {\n                                encouragement.field.data(\"skip-encouraged-fields\", true);\n                                $form.append('<input type=\"hidden\" name=\"save\" value=\"1\">');\n                                $form.trigger(\"submit\");\n                            }\n                        },\n                        fill: {\n                            label: encouragement.field.data('encouraged-fill'),\n                            callback: function() {\n                                encouragement.field.scrollintoview({top_offset: -50});\n                            }\n                        }\n                    }\n                });\n            } else {\n                $(window).off(\"beforeunload\", MotionEditForm.onLeavePage);\n            }\n        }\n    }\n\n    private getEncouragedFieldError($form: JQuery): {field: JQuery, error: string}|null {\n        let result: {field: JQuery, error: string}|null = null;\n        $form.find('.wysiwyg-textarea').each(function() {\n            const $field = $(this),\n                $label = $field.find(\"label.encouraged\");\n\n            if ($label.length === 0) {\n                return;\n            }\n\n            const text = $field.find(\"textarea\").val().trim();\n            if (text && text !== '<p></p>' && text !== '&nbsp;') {\n                return;\n            }\n\n            if ($label.data(\"skip-encouraged-fields\")) {\n                return;\n            }\n\n            result = {field: $label, error: $label.data(\"encouraged-str\")}\n        });\n\n        return result;\n    }\n\n    private checkMultipleTagsError(): boolean {\n        let $group: JQuery = this.$form.find('.multipleTagsGroup');\n        if ($group.length === 0) {\n            return false;\n        }\n\n        if (this.$form.find('.multipleTagsGroup input[type=checkbox]').length) {\n            // Checkboxes: multiple tags are allowed, but also none\n            $group.removeClass('has-error');\n            return false;\n        }\n\n        // From here on: radios\n        if ($group.find('input:checked').length > 0) {\n            $group.removeClass('has-error');\n            return false;\n        } else {\n            $group.addClass('has-error');\n            $group.scrollintoview({top_offset: -50});\n            return true;\n        }\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    private initWysiwyg(i, el) {\n        let $holder = $(el),\n            $textarea = $holder.find(\".texteditor\"),\n            editor = new AntragsgruenEditor($textarea.attr(\"id\"));\n\n        $textarea.parents(\"form\").on(\"submit\", () => {\n            $textarea.parent().find(\"textarea\").val(editor.getEditor().getData());\n        });\n        editor.getEditor().on('change', () => {\n            if (!this.hasChanged) {\n                this.hasChanged = true;\n                if (!$(\"body\").hasClass('testing')) {\n                    $(window).on(\"beforeunload\", MotionEditForm.onLeavePage);\n                }\n            }\n        });\n    }\n\n    private initPlainTextFormGroup(i, el) {\n        let $fieldset = $(el),\n            $input = $fieldset.find(\"input.form-control\");\n        if ($fieldset.data(\"max-len\") != 0) {\n            let maxLen = $fieldset.data(\"max-len\"),\n                maxLenSoft = false,\n                $warning = $fieldset.find('.maxLenTooLong'),\n                $submit = $fieldset.parents(\"form\").first().find(\"button[type=submit]\"),\n                $currCounter = $fieldset.find(\".maxLenHint .counter\");\n            if (maxLen < 0) {\n                maxLenSoft = true;\n                maxLen = -1 * maxLen;\n            }\n\n            $input.on('keyup change', () => {\n                let currLen = ($input.val() as string).length;\n                $currCounter.text(currLen);\n                if (currLen > maxLen) {\n                    $warning.removeClass('hidden');\n                    if (!maxLenSoft) {\n                        $submit.prop(\"disabled\", true);\n                    }\n                } else {\n                    $warning.addClass('hidden');\n                    if (!maxLenSoft) {\n                        $submit.prop(\"disabled\", false);\n                    }\n                }\n            }).trigger('change');\n        }\n    }\n}\n"]}