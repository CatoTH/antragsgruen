{"version":3,"sources":["frontend/AmendmentEdit.js","frontend/AmendmentEdit.ts"],"names":["define","require","exports","AntragsgruenEditor_1","DraftSavingEngine_1","Object","defineProperty","value","AmendmentEdit","constructor","$form","this","hasChanged","isSingleLocationMode","multiParagraphMode","parseInt","data","lang","$","attr","find","on","editorialOpenerClicked","bind","trigger","initGlobalAlternative","datetimepicker","locale","format","initMultiParagraphMode","spmInit","$draftHint","draftMotionId","draftAmendmentId","DraftSavingEngine","window","off","onLeavePage","$holder","$textarea","prop","removeClass","undefined","CKEDITOR","instances","editor","AntragsgruenEditor","parents","parent","val","getEditor","getData","onContentChanged","addClass","each","i","el","ckeditor","plugins","lite","findPlugin","acceptAll","ev","$text","currentTarget","setData","spmSetModifyable","$modified","$spmParagraphs","filter","length","spmOnParaClick","$para","hasClass","hasMultipleChanges","preventDefault","stopPropagation","scrollintoview","top_offset","countIns","countDel","innerText","spmRevert","target","destroyInstanceById","html","spmInitNonSingleParas","$this","sectionId","paraNo","__t"],"mappings":"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","file":"AmendmentEdit.js","sourcesContent":[null,"import {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\nimport {DraftSavingEngine} from \"../shared/DraftSavingEngine\";\n\n// Keep in sync with ConsultationMotionType.php\nconst AMEND_PARAGRAPHS_MULTIPLE = 1;\nconst AMEND_PARAGRAPHS_SINGLE_PARAGRAPH = 0;\nconst AMEND_PARAGRAPHS_SINGLE_CHANGE = -1;\n\nexport class AmendmentEdit {\n    private lang: string;\n    private $spmParagraphs: JQuery;\n    private hasChanged: boolean = false;\n    private isSingleLocationMode = false;\n\n    constructor(private $form: JQuery) {\n        let multiParagraphMode = parseInt($form.data(\"multi-paragraph-mode\"), 10);\n        if (typeof(multiParagraphMode) == \"undefined\") {\n            throw \"data-multi-paragraph-mode needs to be set\";\n        }\n\n        this.lang = $(\"html\").attr('lang');\n\n        this.$form.find(\".editorialChange input\").on(\"change\", this.editorialOpenerClicked.bind(this)).trigger(\"change\");\n        this.initGlobalAlternative();\n\n        $(\".input-group.date\").datetimepicker({\n            locale: this.lang,\n            format: 'L'\n        });\n\n        if (multiParagraphMode === AMEND_PARAGRAPHS_MULTIPLE) {\n            this.initMultiParagraphMode();\n        } else {\n            this.isSingleLocationMode = multiParagraphMode === AMEND_PARAGRAPHS_SINGLE_CHANGE;\n            this.spmInit();\n        }\n\n        let $draftHint = $(\"#draftHint\"),\n            draftMotionId = $draftHint.data(\"motion-id\"),\n            draftAmendmentId = $draftHint.data(\"amendment-id\");\n\n        new DraftSavingEngine($form, $draftHint, \"motion_\" + draftMotionId + \"_\" + draftAmendmentId);\n\n        $form.on(\"submit\", () => {\n            $(window).off(\"beforeunload\", AmendmentEdit.onLeavePage);\n        });\n    }\n\n    private initGlobalAlternative() {\n\n    }\n\n    private editorialOpenerClicked() {\n        let $holder = this.$form.find(\"#sectionHolderEditorial\"),\n            $textarea = $holder.find(\".texteditor\"),\n            active = this.$form.find(\".editorialChange input\").prop(\"checked\");\n\n        if (active) {\n            $holder.removeClass(\"hidden\");\n            if (CKEDITOR.instances['amendmentEditorial_wysiwyg'] === undefined) {\n                let editor: AntragsgruenEditor = new AntragsgruenEditor(\"amendmentEditorial_wysiwyg\");\n                $textarea.parents(\"form\").on(\"submit\", () => {\n                    if (this.$form.find(\".editorialChange input\").prop(\"checked\")) {\n                        $textarea.parent().find(\"textarea.raw\").val(editor.getEditor().getData());\n                    } else {\n                        $textarea.parent().find(\"textarea.raw\").val(\"\");\n                    }\n                });\n                $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n            }\n        } else {\n            $holder.addClass(\"hidden\");\n        }\n    }\n\n    /* Multi paragraph mode */\n\n    private initMultiParagraphMode() {\n        $(\".wysiwyg-textarea:not(#sectionHolderEditorial)\").each((i, el) => {\n            let $holder = $(el),\n                $textarea = $holder.find(\".texteditor\");\n\n            let editor: AntragsgruenEditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                ckeditor: CKEDITOR.editor = editor.getEditor();\n\n            $textarea.parents(\"form\").on(\"submit\", () => {\n                $textarea.parent().find(\"textarea.raw\").val(ckeditor.getData());\n                if (typeof(ckeditor.plugins.lite) != 'undefined') {\n                    ckeditor.plugins.lite.findPlugin(ckeditor).acceptAll();\n                    $textarea.parent().find(\"textarea.consolidated\").val(ckeditor.getData());\n                }\n            });\n\n            // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n            $('#' + $textarea.attr('id')).on('keypress', this.onContentChanged.bind(this));\n        });\n\n        this.$form.find('.resetText').on(\"click\", (ev) => {\n            let $text: JQuery = $(ev.currentTarget).parents('.wysiwyg-textarea').find('.texteditor');\n            window['CKEDITOR']['instances'][$text.attr('id')].setData($text.data('original-html'));\n\n            $(ev.currentTarget).parents('.modifiedActions').addClass('hidden');\n        });\n    }\n\n    /* Single paragraph mode */\n\n    private spmSetModifyable() {\n        let $modified = this.$spmParagraphs.filter(\".modified\");\n        if ($modified.length == 0) {\n            this.$spmParagraphs.addClass('modifyable');\n        } else {\n            this.$spmParagraphs.removeClass('modifyable');\n            $('input[name=modifiedParagraphNo]').val($modified.data(\"paragraph-no\"));\n            $('input[name=modifiedSectionId]').val($modified.parents(\".texteditorBox\").data(\"section-id\"));\n        }\n    }\n\n    private spmOnParaClick(ev) {\n        let $para = $(ev.currentTarget);\n        if (!$para.hasClass('modifyable')) {\n            return;\n        }\n        $para.addClass('modified');\n        this.spmSetModifyable();\n\n        let $textarea = $para.find(\".texteditor\"),\n            editor;\n        if (typeof(CKEDITOR.instances[$textarea.attr(\"id\")]) !== \"undefined\") {\n            editor = CKEDITOR.instances[$textarea.attr(\"id\")];\n        } else {\n            editor = (new AntragsgruenEditor($textarea.attr(\"id\"))).getEditor();\n        }\n        $textarea.attr(\"contenteditable\", \"true\");\n        $textarea.parents(\"form\").on(\"submit\", (ev) => {\n            if (this.isSingleLocationMode && hasMultipleChanges()) {\n                ev.preventDefault();\n                ev.stopPropagation();\n                $para.find('.oneChangeHint').removeClass('hidden');\n                $para.scrollintoview({top_offset: -100});\n                return;\n            }\n\n            $textarea.parent().find(\"textarea.raw\").val(editor.getData());\n            if (typeof(editor.plugins.lite) != 'undefined') {\n                editor.plugins.lite.findPlugin(editor).acceptAll();\n                $textarea.parent().find(\"textarea.consolidated\").val(editor.getData());\n            }\n        });\n\n        const hasMultipleChanges = (): boolean => {\n            // Undo / Cmd/Ctrl-Z leaves behind strange characters, that's why we need to take care of some special cases\n            let countIns = 0,\n                countDel = 0;\n            $textarea.find(\".ice-ins\").each(function() {\n                if ($(this)[0].innerText.length > 0 && $(this)[0].innerText !== \"\\ufeff\") {\n                    countIns++;\n                }\n            });\n            $textarea.find(\".ice-del\").each(function() {\n                if ($(this)[0].innerText.length > 0 && $(this)[0].innerText !== \"\\ufeff\") {\n                    countDel++;\n                }\n            });\n            return (countIns > 1 || countDel > 1);\n        };\n\n        const setSingleLocWarning = () => {\n            if (!this.isSingleLocationMode) {\n                return;\n            }\n\n            if (hasMultipleChanges()) {\n                $para.find('.oneChangeHint').removeClass('hidden');\n            } else {\n                $para.find('.oneChangeHint').addClass('hidden');\n            }\n        };\n\n        // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n        $(\"#\" + $textarea.attr(\"id\"))\n            .on('keypress', this.onContentChanged.bind(this))\n            .on('keyup', setSingleLocWarning.bind(this));\n\n        $textarea.trigger(\"focus\");\n    }\n\n    private spmRevert(ev) {\n        ev.preventDefault();\n        ev.stopPropagation();\n        let $para = $(ev.target).parents(\".wysiwyg-textarea\"),\n            $textarea = $para.find(\".texteditor\");\n\n        if (typeof(CKEDITOR.instances[$textarea.attr(\"id\")]) !== \"undefined\") {\n            AntragsgruenEditor.destroyInstanceById($textarea.attr(\"id\"));\n        }\n\n        $textarea.html($para.data(\"original\"));\n        $para.removeClass(\"modified\");\n        $para.find('.oneChangeHint').addClass('hidden');\n        this.spmSetModifyable();\n    }\n\n    private spmInitNonSingleParas(i, el) {\n        let $holder = $(el),\n            $textarea = $holder.find(\".texteditor\");\n        if ($holder.hasClass(\"hidden\")) {\n            return;\n        }\n        let editor: CKEDITOR.editor = (new AntragsgruenEditor($textarea.attr(\"id\"))).getEditor();\n        $textarea.parents(\"form\").on(\"submit\", () => {\n            $textarea.parent().find(\"textarea.raw\").val(editor.getData());\n            if (typeof(editor.plugins.lite) != 'undefined') {\n                editor.plugins.lite.findPlugin(editor).acceptAll();\n                $textarea.parent().find(\"textarea.consolidated\").val(editor.getData());\n            }\n        });\n\n        // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n        $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n    }\n\n    private spmInit() {\n        this.$spmParagraphs = $(\".wysiwyg-textarea.single-paragraph\");\n        this.$spmParagraphs.on(\"click\", this.spmOnParaClick.bind(this));\n        this.$spmParagraphs.find(\".modifiedActions .revert\").on(\"click\", this.spmRevert.bind(this));\n        this.spmSetModifyable();\n\n        // Amendment Reason\n        $(\".wysiwyg-textarea\").filter(\":not(.single-paragraph)\").each(this.spmInitNonSingleParas.bind(this));\n\n        $(\".texteditorBox\").each((i, el) => {\n            let $this = $(el),\n                sectionId = $this.data(\"section-id\"),\n                paraNo = $this.data(\"changed-para-no\");\n            if (paraNo > -1) {\n                $(\"#section_holder_\" + sectionId + \"_\" + paraNo).trigger(\"click\");\n            }\n        });\n\n        if (this.$form.data('init-section-id')) {\n            const $holder = $(\"#section_holder_\" + this.$form.data('init-section-id') + \"_\" + this.$form.data('init-paragraph-no'));\n            $holder.trigger(\"click\");\n            $holder.scrollintoview({top_offset: -100});\n        }\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    public onContentChanged() {\n\n        if (!this.hasChanged) {\n            this.hasChanged = true;\n            if (!$(\"body\").hasClass('testing')) {\n                $(window).on(\"beforeunload\", AmendmentEdit.onLeavePage);\n            }\n        }\n    }\n}\n"]}