{"version":3,"sources":["shared/DraftSavingEngine.js","shared/DraftSavingEngine.ts"],"names":["define","require","exports","Object","defineProperty","value","DraftSavingEngine","constructor","$form","$draftHint","keyBase","this","isChanged","$html","$","hasClass","key","localKey","Math","floor","random","append","localStorage","hasOwnProperty","indexOf","data","JSON","parse","getItem","lastEdit","Date","$link","__t","dateStr","Intl","DateTimeFormat","attr","weekday","year","month","day","hour","minute","format","find","text","on","ev","preventDefault","$li","delegateTarget","parents","first","bootbox","confirm","result","doRestore","doDelete","removeClass","window","setTimeout","saveInitialData","bind","setInterval","doBackup","inst","CKEDITOR","instances","getData","each","$input","val","foundChanged","dat","id","getTime","setItem","stringify","removeItem","remove","children","length","addClass","restoreKey","setData","trigger","i","el","hasChanges"],"mappings":"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","file":"DraftSavingEngine.js","sourcesContent":[null,"export class DraftSavingEngine {\n    private $html: JQuery;\n    private localKey: string;\n    private isChanged: boolean = false;\n\n    constructor(private $form: JQuery, private $draftHint: JQuery, keyBase: string) {\n        this.$html = $('html');\n\n        if (!this.$html.hasClass(\"localstorage\")) {\n            return;\n        }\n\n        this.localKey = keyBase + \"_\" + Math.floor(Math.random() * 1000000);\n\n        let key;\n\n        $form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + this.localKey + '\">');\n\n        for (key in localStorage) if (localStorage.hasOwnProperty(key)) {\n            if (key.indexOf(keyBase + \"_\") == 0) {\n                let data = JSON.parse(localStorage.getItem(key)),\n                    lastEdit = new Date(data['lastEdit']),\n                    $link = $(\"<li><button type='button' class='btn-link restore'></button> \" +\n                        \"<button type='button' class='btn-link delete' title='\" + __t(\"std\", \"draft_del\") + \"' aria-label='\" + __t(\"std\", \"draft_del\") + \"'>\" +\n                        \"<span class='glyphicon glyphicon-trash' aria-hidden='true'></button>\" +\n                        \"</li>\");\n\n\n                $link.data(\"key\", key);\n                let dateStr = new Intl.DateTimeFormat(this.$html.attr(\"lang\"), {\n                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',\n                    hour: 'numeric', minute: 'numeric'\n                }).format(lastEdit);\n                $link.find('.restore').text(__t(\"std\", \"draft_date\") + ': ' + dateStr).on(\"click\", (ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_restore_confirm\"), (result) => {\n                        if (result) {\n                            this.doRestore($li);\n                        }\n                    });\n                });\n                $link.find('.delete').on(\"click\", (ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_del_confirm\"), (result) => {\n                        if (result) {\n                            this.doDelete($li);\n                        }\n                    });\n                });\n                this.$draftHint.find(\"ul\").append($link);\n                this.$draftHint.removeClass(\"hidden\");\n            }\n        }\n\n        window.setTimeout(this.saveInitialData.bind(this), 2000);\n\n        window.setInterval(this.doBackup.bind(this), 3000);\n    }\n\n    private saveInitialData() {\n        for (let inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                $(\"#\" + inst).data(\"original\", CKEDITOR.instances[inst].getData());\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            $input.data(\"original\", $input.val());\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\");\n            $input.data(\"original\", $input.val());\n        });\n    }\n\n    private doBackup() {\n        let data = {},\n            foundChanged = false,\n            inst;\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                let dat = CKEDITOR.instances[inst].getData();\n                data[inst] = dat;\n                if (dat != $(\"#\" + inst).data(\"original\")) {\n                    foundChanged = true;\n                }\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            data[$input.attr(\"id\")] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\"),\n                id = $(this).find(\".stdDropdown\").attr(\"id\");\n            data[id] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n\n        if (foundChanged) {\n            data['lastEdit'] = new Date().getTime();\n            localStorage.setItem(this.localKey, JSON.stringify(data));\n            this.isChanged = true;\n        } else {\n            localStorage.removeItem(this.localKey);\n            this.isChanged = false;\n        }\n    }\n\n    private doDelete($li: JQuery) {\n        localStorage.removeItem($li.data(\"key\"));\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    };\n\n    private doRestore($li: JQuery) {\n        let inst,\n            restoreKey = $li.data(\"key\"),\n            data = JSON.parse(localStorage.getItem(restoreKey));\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                if (typeof(data[inst]) != \"undefined\") {\n                    CKEDITOR.instances[inst].setData(data[inst]);\n                }\n            }\n        }\n        if (data.hasOwnProperty(\"amendmentEditorial_wysiwyg\") && data['amendmentEditorial_wysiwyg'] != '') {\n            if (!CKEDITOR.hasOwnProperty('amendmentEditorial_wysiwyg')) {\n                $(\".editorialChange .opener\").trigger(\"click\");\n                window.setTimeout(function () {\n                    CKEDITOR.instances['amendmentEditorial_wysiwyg'].setData(data['amendmentEditorial_wysiwyg']);\n                }, 100);\n            }\n        }\n\n        $(\".form-group.plain-text\").each((i, el) => {\n            let $input = $(el).find(\"input[type=text]\");\n            if (typeof(data[$input.attr(\"id\")]) != \"undefined\") {\n                $input.val(data[$input.attr(\"id\")]);\n            }\n        });\n        $(\".form-group.amendmentStatus\").each((i, el) => {\n            let id = $(el).find(\".stdDropdown\").attr(\"id\");\n            if (typeof(data[id]) != \"undefined\") {\n                $('#' + id).val(data[id]);\n            }\n        });\n\n        this.$form.find(\"input[name=draftId]\").remove();\n        this.$form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + restoreKey + '\">');\n\n        this.localKey = restoreKey;\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    }\n\n    public hasChanges(): boolean {\n        return this.isChanged;\n    }\n}\n"]}