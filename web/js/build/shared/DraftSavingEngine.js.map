{"version":3,"sources":["shared/DraftSavingEngine.ts"],"names":["DraftSavingEngine","$form","$draftHint","keyBase","_this","this","isChanged","$html","$","hasClass","key","localKey","Math","floor","random","append","localStorage","hasOwnProperty","indexOf","data","JSON","parse","getItem","lastEdit","Date","$link","__t","dateStr","Intl","DateTimeFormat","attr","weekday","year","month","day","hour","minute","format","find","text","click","ev","preventDefault","$li","delegateTarget","parents","first","bootbox","confirm","result","doRestore","doDelete","removeClass","window","setTimeout","saveInitialData","bind","setInterval","doBackup","prototype","inst","CKEDITOR","instances","getData","each","$input","val","foundChanged","dat","id","getTime","setItem","stringify","removeItem","remove","children","length","addClass","restoreKey","setData","i","el","selectlist","hasChanges","exports"],"mappings":"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","file":"DraftSavingEngine.js","sourcesContent":["export class DraftSavingEngine {\n    private $html: JQuery;\n    private localKey: string;\n    private isChanged: boolean = false;\n\n    constructor(private $form: JQuery, private $draftHint: JQuery, keyBase: string) {\n        this.$html = $('html');\n\n        if (!this.$html.hasClass(\"localstorage\")) {\n            return;\n        }\n\n        this.localKey = keyBase + \"_\" + Math.floor(Math.random() * 1000000);\n\n        let key;\n\n        $form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + this.localKey + '\">');\n\n        for (key in localStorage) if (localStorage.hasOwnProperty(key)) {\n            if (key.indexOf(keyBase + \"_\") == 0) {\n                let data = JSON.parse(localStorage.getItem(key)),\n                    lastEdit = new Date(data['lastEdit']),\n                    $link = $(\"<li><a href='#' class='restore'></a> \" +\n                        \"<a href='#' class='delete glyphicon glyphicon-trash' title='\" + __t(\"std\", \"draft_del\") +\n                        \"'></a></li>\");\n\n\n                $link.data(\"key\", key);\n                let dateStr = new Intl.DateTimeFormat(this.$html.attr(\"lang\"), {\n                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',\n                    hour: 'numeric', minute: 'numeric'\n                }).format(lastEdit);\n                $link.find('.restore').text(__t(\"std\", \"draft_date\") + ': ' + dateStr).click((ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_restore_confirm\"), (result) => {\n                        if (result) {\n                            this.doRestore($li);\n                        }\n                    });\n                });\n                $link.find('.delete').click((ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_del_confirm\"), (result) => {\n                        if (result) {\n                            this.doDelete($li);\n                        }\n                    });\n                });\n                this.$draftHint.find(\"ul\").append($link);\n                this.$draftHint.removeClass(\"hidden\");\n            }\n        }\n\n        window.setTimeout(this.saveInitialData.bind(this), 2000);\n\n        window.setInterval(this.doBackup.bind(this), 3000);\n    }\n\n    private saveInitialData() {\n        for (let inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                $(\"#\" + inst).data(\"original\", CKEDITOR.instances[inst].getData());\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            $input.data(\"original\", $input.val());\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\");\n            $input.data(\"original\", $input.val());\n        });\n    }\n\n    private doBackup() {\n        let data = {},\n            foundChanged = false,\n            inst;\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                let dat = CKEDITOR.instances[inst].getData();\n                data[inst] = dat;\n                if (dat != $(\"#\" + inst).data(\"original\")) {\n                    foundChanged = true;\n                }\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            data[$input.attr(\"id\")] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\"),\n                id = $(this).find(\".selectlist\").attr(\"id\");\n            data[id] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n\n        if (foundChanged) {\n            data['lastEdit'] = new Date().getTime();\n            localStorage.setItem(this.localKey, JSON.stringify(data));\n            this.isChanged = true;\n        } else {\n            localStorage.removeItem(this.localKey);\n            this.isChanged = false;\n        }\n    }\n\n    private doDelete($li: JQuery) {\n        localStorage.removeItem($li.data(\"key\"));\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    };\n\n    private doRestore($li: JQuery) {\n        let inst,\n            restoreKey = $li.data(\"key\"),\n            data = JSON.parse(localStorage.getItem(restoreKey));\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                if (typeof(data[inst]) != \"undefined\") {\n                    CKEDITOR.instances[inst].setData(data[inst]);\n                }\n            }\n        }\n        if (data.hasOwnProperty(\"amendmentEditorial_wysiwyg\") && data['amendmentEditorial_wysiwyg'] != '') {\n            if (!CKEDITOR.hasOwnProperty('amendmentEditorial_wysiwyg')) {\n                $(\".editorialChange .opener\").click();\n                window.setTimeout(function () {\n                    CKEDITOR.instances['amendmentEditorial_wysiwyg'].setData(data['amendmentEditorial_wysiwyg']);\n                }, 100);\n            }\n        }\n\n        $(\".form-group.plain-text\").each((i, el) => {\n            let $input = $(el).find(\"input[type=text]\");\n            if (typeof(data[$input.attr(\"id\")]) != \"undefined\") {\n                $input.val(data[$input.attr(\"id\")]);\n            }\n        });\n        $(\".form-group.amendmentStatus\").each((i, el) => {\n            let id = $(el).find(\".selectlist\").attr(\"id\");\n            if (typeof(data[id]) != \"undefined\") {\n                $('#' + id).selectlist('selectByValue', data[id]);\n            }\n        });\n\n        this.$form.find(\"input[name=draftId]\").remove();\n        this.$form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + restoreKey + '\">');\n\n        this.localKey = restoreKey;\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    }\n\n    public hasChanges(): boolean {\n        return this.isChanged;\n    }\n}\n"]}