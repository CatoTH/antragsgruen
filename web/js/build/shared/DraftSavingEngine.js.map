{"version":3,"sources":["shared/DraftSavingEngine.js","shared/DraftSavingEngine.ts"],"names":["define","require","exports","Object","defineProperty","value","DraftSavingEngine","constructor","$form","$draftHint","keyBase","this","isChanged","$html","$","testLocalstorageEnabled","key","localKey","Math","floor","random","append","localStorage","hasOwnProperty","indexOf","data","JSON","parse","getItem","lastEdit","Date","$link","__t","dateStr","Intl","DateTimeFormat","attr","weekday","year","month","day","hour","minute","format","find","text","on","ev","preventDefault","$li","delegateTarget","parents","first","bootbox","confirm","result","doRestore","doDelete","removeClass","window","setTimeout","saveInitialData","bind","setInterval","doBackup","setItem","removeItem","e","inst","CKEDITOR","instances","getData","each","$input","val","foundChanged","dat","id","getTime","stringify","remove","children","length","addClass","restoreKey","setData","trigger","i","el","hasChanges"],"mappings":"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","file":"DraftSavingEngine.js","sourcesContent":[null,"export class DraftSavingEngine {\n    private $html: JQuery;\n    private localKey: string;\n    private isChanged: boolean = false;\n\n    constructor(private $form: JQuery, private $draftHint: JQuery, keyBase: string) {\n        this.$html = $('html');\n\n        if (!this.testLocalstorageEnabled()) {\n            return;\n        }\n\n        this.localKey = keyBase + \"_\" + Math.floor(Math.random() * 1000000);\n\n        let key;\n\n        $form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + this.localKey + '\">');\n\n        for (key in localStorage) if (localStorage.hasOwnProperty(key)) {\n            if (key.indexOf(keyBase + \"_\") == 0) {\n                let data = JSON.parse(localStorage.getItem(key)),\n                    lastEdit = new Date(data['lastEdit']),\n                    $link = $(\"<li><button type='button' class='btn-link restore'></button> \" +\n                        \"<button type='button' class='btn-link delete' title='\" + __t(\"std\", \"draft_del\") + \"' aria-label='\" + __t(\"std\", \"draft_del\") + \"'>\" +\n                        \"<span class='glyphicon glyphicon-trash' aria-hidden='true'></button>\" +\n                        \"</li>\");\n\n\n                $link.data(\"key\", key);\n                let dateStr = new Intl.DateTimeFormat(this.$html.attr(\"lang\"), {\n                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',\n                    hour: 'numeric', minute: 'numeric'\n                }).format(lastEdit);\n                $link.find('.restore').text(__t(\"std\", \"draft_date\") + ': ' + dateStr).on(\"click\", (ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_restore_confirm\"), (result) => {\n                        if (result) {\n                            this.doRestore($li);\n                        }\n                    });\n                });\n                $link.find('.delete').on(\"click\", (ev) => {\n                    ev.preventDefault();\n                    let $li = $(ev.delegateTarget).parents(\"li\").first();\n                    bootbox.confirm(__t(\"std\", \"draft_del_confirm\"), (result) => {\n                        if (result) {\n                            this.doDelete($li);\n                        }\n                    });\n                });\n                this.$draftHint.find(\"ul\").append($link);\n                this.$draftHint.removeClass(\"hidden\");\n            }\n        }\n\n        window.setTimeout(this.saveInitialData.bind(this), 2000);\n\n        window.setInterval(this.doBackup.bind(this), 3000);\n    }\n\n    private testLocalstorageEnabled(): boolean {\n        try {\n            const key = `__storage__test`;\n            window.localStorage.setItem(key, null);\n            window.localStorage.removeItem(key);\n            return true;\n        } catch (e) {\n            return false;\n        }\n    }\n\n    private saveInitialData() {\n        for (let inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                $(\"#\" + inst).data(\"original\", CKEDITOR.instances[inst].getData());\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            $input.data(\"original\", $input.val());\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\");\n            $input.data(\"original\", $input.val());\n        });\n    }\n\n    private doBackup() {\n        let data = {},\n            foundChanged = false,\n            inst;\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                let dat = CKEDITOR.instances[inst].getData();\n                data[inst] = dat;\n                if (dat != $(\"#\" + inst).data(\"original\")) {\n                    foundChanged = true;\n                }\n            }\n        }\n        $(\".form-group.plain-text\").each(function () {\n            let $input = $(this).find(\"input[type=text]\");\n            data[$input.attr(\"id\")] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n        $(\".form-group.amendmentStatus\").each(function () {\n            let $input = $(this).find(\"input[type=text].hidden\"),\n                id = $(this).find(\".stdDropdown\").attr(\"id\");\n            data[id] = $input.val();\n            if ($input.val() != $input.data(\"original\")) {\n                foundChanged = true;\n            }\n        });\n\n        if (foundChanged) {\n            data['lastEdit'] = new Date().getTime();\n            localStorage.setItem(this.localKey, JSON.stringify(data));\n            this.isChanged = true;\n        } else {\n            localStorage.removeItem(this.localKey);\n            this.isChanged = false;\n        }\n    }\n\n    private doDelete($li: JQuery) {\n        localStorage.removeItem($li.data(\"key\"));\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    }\n\n    private doRestore($li: JQuery) {\n        let inst,\n            restoreKey = $li.data(\"key\"),\n            data = JSON.parse(localStorage.getItem(restoreKey));\n\n        for (inst in CKEDITOR.instances) {\n            if (CKEDITOR.instances.hasOwnProperty(inst)) {\n                if (typeof(data[inst]) != \"undefined\") {\n                    CKEDITOR.instances[inst].setData(data[inst]);\n                }\n            }\n        }\n        if (data.hasOwnProperty(\"amendmentEditorial_wysiwyg\") && data['amendmentEditorial_wysiwyg'] != '') {\n            if (!CKEDITOR.hasOwnProperty('amendmentEditorial_wysiwyg')) {\n                $(\".editorialChange .opener\").trigger(\"click\");\n                window.setTimeout(function () {\n                    CKEDITOR.instances['amendmentEditorial_wysiwyg'].setData(data['amendmentEditorial_wysiwyg']);\n                }, 100);\n            }\n        }\n\n        $(\".form-group.plain-text\").each((i, el) => {\n            let $input = $(el).find(\"input[type=text]\");\n            if (typeof(data[$input.attr(\"id\")]) != \"undefined\") {\n                $input.val(data[$input.attr(\"id\")]);\n            }\n        });\n        $(\".form-group.amendmentStatus\").each((i, el) => {\n            let id = $(el).find(\".stdDropdown\").attr(\"id\");\n            if (typeof(data[id]) != \"undefined\") {\n                $('#' + id).val(data[id]);\n            }\n        });\n\n        this.$form.find(\"input[name=draftId]\").remove();\n        this.$form.append('<input type=\"hidden\" name=\"draftId\" value=\"' + restoreKey + '\">');\n\n        this.localKey = restoreKey;\n        $li.remove();\n        if (this.$draftHint.find(\"ul\").children().length == 0) {\n            this.$draftHint.addClass(\"hidden\");\n        }\n    }\n\n    public hasChanges(): boolean {\n        return this.isChanged;\n    }\n}\n"]}