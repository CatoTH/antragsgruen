{"version":3,"sources":["shared/AntragsgruenEditor.ts"],"names":["AntragsgruenEditor","id","this","$el","$","initialized","data","attr","ckeditorConfig","createConfig","CKEDITOR","ENTER_BR","ENTER_P","focusManager","_","blurDelay","editor","inline","initMaxLen","console","error","ckeditor_strip","html","tmp","document","createElement","innerHTML","textContent","innerText","ckeditor_charcount","text","normalizedText","replace","length","prototype","maxLenOnChange","currLen","getData","$currCounter","maxLen","$warning","removeClass","maxLenSoft","$submit","prop","addClass","$fieldset","parents","first","find","on","bind","title","noStrike","trackChanged","allowDiffFormattings","enterMode","coreStyles_strike","element","attributes","class","overrides","coreStyles_underline","toolbarGroups","name","groups","removePlugins","extraPlugins","scayt_sLang","strikeEl","strikeClass","allowedContent","tooltips","getEditor","destroyInstanceById","instances","destroy","exports"],"mappings":"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","file":"AntragsgruenEditor.js","sourcesContent":["import domObject = CKEDITOR.dom.domObject;\nimport editor = CKEDITOR.editor;\n\nexport class AntragsgruenEditor {\n    private editor: editor;\n    private $el: JQuery;\n\n    private static ckeditor_strip(html: string): string {\n        let tmp = document.createElement(\"div\");\n        tmp.innerHTML = html;\n\n        if (tmp.textContent == '' && typeof tmp.innerText == 'undefined') {\n            return '';\n        }\n\n        return tmp.textContent || tmp.innerText;\n    }\n\n    private static ckeditor_charcount(text: string): number {\n        let normalizedText = text.replace(/(\\r\\n|\\n|\\r)/gm, \"\").replace(/^\\s+|\\s+$/g, \"\").replace(\"&nbsp;\", \"\");\n        normalizedText = AntragsgruenEditor.ckeditor_strip(normalizedText).replace(/^([\\s\\t\\r\\n]*)$/, \"\");\n\n        return normalizedText.length;\n    }\n\n    private $currCounter: JQuery;\n    private $warning: JQuery;\n    private $submit: JQuery;\n    private maxLen: number;\n    private maxLenSoft: boolean;\n\n    private maxLenOnChange() {\n        let currLen = AntragsgruenEditor.ckeditor_charcount(this.editor.getData());\n        this.$currCounter.text(currLen);\n        if (currLen > this.maxLen) {\n            this.$warning.removeClass('hidden');\n            if (!this.maxLenSoft) {\n                this.$submit.prop(\"disabled\", true);\n            }\n        } else {\n            this.$warning.addClass('hidden');\n            if (!this.maxLenSoft) {\n                this.$submit.prop(\"disabled\", false);\n            }\n        }\n    }\n\n    private initMaxLen() {\n        let $fieldset = this.$el.parents(\".wysiwyg-textarea\").first();\n        if (!$fieldset.data(\"max-len\")) {\n            return;\n        }\n\n        this.maxLen = $fieldset.data(\"max-len\");\n        this.maxLenSoft = false;\n        this.$warning = $fieldset.find('.maxLenTooLong');\n        this.$submit = this.$el.parents(\"form\").first().find(\"button[type=submit]\");\n        this.$currCounter = $fieldset.find(\".maxLenHint .counter\");\n\n        if (this.maxLen < 0) {\n            this.maxLenSoft = true;\n            this.maxLen = -1 * this.maxLen;\n        }\n\n        this.editor.on('change', this.maxLenOnChange.bind(this));\n        this.maxLenOnChange();\n    }\n\n    private static createConfig(title: string, noStrike: boolean, trackChanged: boolean, allowDiffFormattings: boolean, enterMode: any): any {\n        let ckeditorConfig = {\n            coreStyles_strike: {\n                element: 'span',\n                attributes: {'class': 'strike'},\n                overrides: 'strike'\n            },\n            coreStyles_underline: {\n                element: 'span',\n                attributes: {'class': 'underline'}\n            },\n            toolbarGroups: [\n                {name: 'tools'},\n                {name: 'document', groups: ['mode', 'document', 'doctools']},\n                //{name: 'clipboard', groups: ['clipboard', 'undo']},\n                //{name: 'editing', groups: ['find', 'selection', 'spellchecker']},\n                //{name: 'forms'},\n                {name: 'basicstyles', groups: ['basicstyles', 'cleanup']},\n                {name: 'paragraph', groups: ['list', 'indent', 'blocks', 'align', 'bidi']},\n                {name: 'links'},\n                {name: 'insert'},\n                {name: 'styles'},\n                {name: 'colors'},\n                {name: 'others'}\n            ],\n            removePlugins: 'stylescombo,save,showblocks,specialchar,about,preview,pastetext,magicline',\n            extraPlugins: 'tabletools',\n            scayt_sLang: 'de_DE',\n            title: title,\n            enterMode: enterMode\n        };\n\n        let strikeEl = (noStrike ? '' : ' s'),\n            strikeClass = (noStrike ? '' : ',strike'),\n            allowedContent = '';\n\n        if (trackChanged || allowDiffFormattings) {\n            allowedContent = 'strong' + strikeEl + ' em u sub sup;' +\n                'h1 h2 h3 h4;' +\n                'ul ol li [data-*](ice-ins,ice-del,ice-cts,appendHint,moved){list-style-type};' +\n                //'table tr td th tbody thead caption [border] {margin,padding,width,height,border,border-spacing,border-collapse,align,cellspacing,cellpadding};' +\n                'div [data-*](collidingParagraph,paragraphHolder,hasCollissions,moved);' +\n                'p blockquote [data-*](ice-ins,ice-del,ice-cts,appendHint,collidingParagraphHead,moved){border,margin,padding};' +\n                'span[data-*](ice-ins,ice-del,ice-cts,appendHint,underline' + strikeClass + ',subscript,superscript);' +\n                'a[href,data-*](ice-ins,ice-del,ice-cts,appendHint);' +\n                'br ins del[data-*](ice-ins,ice-del,ice-cts,appendHint);';\n        } else {\n            allowedContent = 'strong' + strikeEl + ' em u sub sup;' +\n                'ul ol li {list-style-type};' +\n                'h2 h3 h4;' +\n                //'table tr td th tbody thead caption [border] {margin,padding,width,height,border,border-spacing,border-collapse,align,cellspacing,cellpadding};' +\n                'p blockquote {border,margin,padding};' +\n                'span(underline' + strikeClass + ',subscript,superscript);' +\n                'a[href];';\n        }\n\n        if (trackChanged) {\n            ckeditorConfig.extraPlugins += ',lite';\n            ckeditorConfig['lite'] = {tooltips: false};\n\n            // Undo and Track changes are incompatible\n            // https://github.com/CatoTH/antragsgruen/issues/224\n            // http://dev.ckeditor.com/ticket/14854\n            ckeditorConfig['removePlugins'] += ',undo';\n        } else {\n            ckeditorConfig['removePlugins'] += ',lite';\n        }\n        ckeditorConfig['allowedContent'] = allowedContent;\n        // ckeditorConfig.pasteFilter = allowedContent; // Seems to break copy/pasting some <strong> formatting in 4.5.11\n\n        return ckeditorConfig\n    }\n\n    public getEditor(): editor {\n        return this.editor;\n    }\n\n    public static destroyInstanceById(id: string) {\n        let editor = CKEDITOR.instances[id];\n        editor.destroy();\n        let $el: JQuery = $(\"#\" + id);\n        $el.data(\"ckeditor_initialized\", \"0\");\n        $el.attr(\"contenteditable\", \"false\");\n    }\n\n    constructor(id) {\n        this.$el = $(\"#\" + id);\n\n        let initialized = this.$el.data(\"ckeditor_initialized\");\n        if (typeof (initialized) != \"undefined\" && initialized == \"1\") {\n            console.error(\"Already initialized: \" + id);\n            return;\n        }\n        \n        this.$el.data(\"ckeditor_initialized\", \"1\");\n        this.$el.attr(\"contenteditable\", \"true\");\n\n        let ckeditorConfig = AntragsgruenEditor.createConfig(\n            this.$el.attr(\"title\"),\n            (this.$el.data(\"no-strike\") == '1'),\n            (this.$el.data('track-changed') == '1'),\n            (this.$el.data('allow-diff-formattings') == '1'),\n            (this.$el.data('enter-mode') == 'br' ? CKEDITOR.ENTER_BR : CKEDITOR.ENTER_P)\n        );\n\n        // This prevents strange behavior in chrome: after switching from the WYSIWYG editor field to a regular input,\n        // the focus of the new input field was lost after 200ms\n        let focusManager: any = CKEDITOR.focusManager;\n        focusManager._.blurDelay = 0;\n\n        this.editor = CKEDITOR.inline(id, ckeditorConfig);\n\n        this.initMaxLen();\n    }\n}\n"]}