{"version":3,"sources":["backend/ProposedProcedureOverview.ts"],"names":["ResponsibilitySetter","ProposedProcedureOverview","constructor","$widget","this","plannedInterval","csrf","find","val","on","onVisibleChanged","bind","initComments","initTagsEdit","initUpdateWidget","onContentUpdated","$","ev","preventDefault","currentTarget","next","removeClass","each","i","el","scrollTop","scrollHeight","$checkbox","data","_csrf","visible","prop","id","parents","first","post","ret","alert","openWriting","$btn","submitComment","originalEvent","key","$textarea","$col","addClass","selectize","create","plugins","render","option_create","escape","__t","input","stopPropagation","saveUrl","select","ajax","url","type","JSON","stringify","tags","items","processData","contentType","dataType","headers","success","msg_error","bootbox","reload","catch","err","responseText","$td","trigger","$commentTd","comment","console","log","$comment","clone","text","html","insertBefore","window","setTimeout","skipReload","length","cb","updateUrl","$dateField","date","$proposalList","error","executeInterval","startInterval","stopInterval","clearTimeout","$updateWidget","$toggle"],"mappings":"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","file":"ProposedProcedureOverview.js","sourcesContent":["import { ResponsibilitySetter } from './ResponsibilitySetter';\n\ninterface ReloadResult {\n    success: boolean;\n    error?: string;\n    html?: string;\n    date?: string;\n}\n\nexport class ProposedProcedureOverview {\n    private csrf: string;\n    private updateUrl: string;\n    private $updateWidget: JQuery;\n    private $proposalList: JQuery;\n    private $dateField: JQuery;\n    private plannedInterval: number = null;\n\n    constructor(private $widget: JQuery) {\n        this.csrf = this.$widget.find('input[name=_csrf]').val() as string;\n        this.$widget.on('change', 'input[name=visible]', this.onVisibleChanged.bind(this));\n        this.initComments();\n        this.initTagsEdit();\n        this.initUpdateWidget();\n        this.onContentUpdated();\n\n        new ResponsibilitySetter($('.proposedProcedureReloadHolder'));\n\n        this.$widget.on('click', '.contactShow', (ev) => {\n            ev.preventDefault();\n            $(ev.currentTarget).next('.contactDetails').removeClass('hidden');\n        });\n    }\n\n    private onContentUpdated() {\n        this.$widget.find(\".commentList\").each((i, el) => {\n            el.scrollTop = el.scrollHeight;\n        });\n    }\n\n    private onVisibleChanged(ev) {\n        let $checkbox = $(ev.currentTarget);\n\n        let data = {\n            '_csrf': this.csrf,\n            'visible': ($checkbox.prop('checked') ? 1 : 0),\n            'id': $checkbox.parents('.item').first().data('id'),\n        };\n        $.post($checkbox.data('save-url'), data, (ret) => {\n            if (!ret['success']) {\n                if (ret['error']) {\n                    alert(ret['error']);\n                }\n                return;\n            }\n        });\n    }\n\n    private initComments() {\n        this.$widget.on('click', '.writingOpener', this.openWriting.bind(this));\n\n        this.$widget.on('click', '.submitComment', (ev) => {\n            ev.preventDefault();\n            let $btn = $(ev.currentTarget);\n            this.submitComment($btn.parents('td').first());\n        });\n\n        this.$widget.on('click', '.cancelWriting', (ev) => {\n            ev.preventDefault();\n            $(ev.currentTarget).parents('td').first().removeClass('writing');\n        });\n\n        this.$widget.on('keypress', 'textarea', (ev) => {\n            if (ev.originalEvent['metaKey'] && ev.originalEvent.key === 'Enter') {\n                let $textarea = $(ev.currentTarget);\n                this.submitComment($textarea.parents('td').first());\n            }\n        });\n    }\n\n    private initTagsEdit() {\n        this.$widget.on('click', '.tagEditOpener', (ev) => {\n            const $col = $(ev.currentTarget).parents(\".procedure\").first();\n            $col.find('.noTags, .tagNames').addClass('hidden');\n            $col.find('.tagsSelector').removeClass('hidden').addClass('editing');\n\n            const $tagsSelect = $col.find('.tagsSelector select') as any;\n            $tagsSelect.selectize({\n                create: true,\n                plugins: [\"remove_button\"],\n                render: {\n                    option_create: (data, escape) => {\n                        return '<div class=\"create\">' + __t('std', 'add_tag') + ': <strong>' + escape(data.input) + '</strong></div>';\n                    }\n                }\n            });\n        });\n\n        this.$widget.on('click', '.tagsSaver', (ev) => {\n            ev.preventDefault();\n            ev.stopPropagation();\n            const $btn = $(ev.currentTarget),\n                saveUrl = $btn.data('save-url'),\n                $col = $btn.parents(\".procedure\").first(),\n                select = $col.find(\".tagsSelector select\")[0] as any;\n\n            $.ajax({\n                url: saveUrl,\n                type: \"POST\",\n                data: JSON.stringify({tags: select.selectize.items}),\n                processData: false,\n                contentType: \"application/json; charset=utf-8\",\n                dataType: \"json\",\n                headers: {\"X-CSRF-Token\": this.csrf},\n                success: data => {\n                    if (data.msg_error) {\n                        bootbox.alert(data.msg_error);\n                    } else {\n                        $col.find('.tagsSelector').addClass('hidden').removeClass('editing');\n                        this.reload(() => {});\n                    }\n                }\n            }).catch(function (err) {\n                alert(err.responseText);\n            })\n        });\n    }\n\n    private openWriting(ev) {\n        ev.preventDefault();\n        let $btn = $(ev.currentTarget),\n            $td = $btn.parents('td').first();\n\n        $td.addClass('writing');\n        $td.find('textarea').trigger(\"focus\");;\n    }\n\n    private submitComment($commentTd: JQuery) {\n        $.ajax({\n            url: $commentTd.data('post-url'),\n            type: \"POST\",\n            data: JSON.stringify({\n                'comment': $commentTd.find('textarea').val(),\n                'id': $commentTd.parents('.item').data('id'),\n            }),\n            processData: false,\n            contentType: \"application/json; charset=utf-8\",\n            dataType: \"json\",\n            headers: {\"X-CSRF-Token\": this.csrf},\n            success: ret => {\n                console.log(ret);\n                if (!ret['success']) {\n                    if (ret['error']) {\n                        alert(ret['error']);\n                    }\n                    return;\n                }\n                let $comment = $commentTd.find('.template').clone();\n                $comment.find('.date').text(ret['date_str']);\n                $comment.find('.name').text(ret['user_str']);\n                $comment.find('.comment').html(ret['text']);\n                $comment.removeClass('template');\n                $comment.insertBefore($commentTd.find('.template'));\n                window.setTimeout(() => {\n                    $commentTd.find(\".commentList\")[0].scrollTop = $commentTd.find(\".commentList\")[0].scrollHeight;\n                }, 1);\n\n                $commentTd.find('textarea').val('');\n                $commentTd.removeClass('writing');\n            }\n        }).catch(() => {\n            alert('Could not save');\n        });\n    }\n\n\n    private skipReload(): boolean {\n        if (this.$widget.find('.respHolder.dropdown.open').length > 0) {\n            return true;\n        } else if (this.$widget.find('.comments.writing').length > 0) {\n            return true;\n        } else if (this.$widget.find('.tagsSelector.editing').length > 0) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    private reload(cb) {\n        if (this.skipReload()) {\n            console.log('No reload, as comment writing is active');\n            cb();\n            return;\n        }\n        $.ajax({\n            type: \"GET\",\n            url: this.updateUrl,\n            success: (data: ReloadResult) => {\n                if (!data.success) {\n                    if (data.error) {\n                        alert(data.error);\n                    }\n                    return;\n                }\n                this.$dateField.text(data.date);\n                this.$proposalList.html(data.html);\n                this.onContentUpdated();\n\n                cb();\n            },\n            error: () => {\n                cb();\n            }\n        })\n    }\n\n    private executeInterval() {\n        this.reload(() => {\n            this.plannedInterval = window.setTimeout(this.executeInterval.bind(this), 5000);\n        });\n    }\n\n    private startInterval() {\n        if (this.plannedInterval !== null) {\n            return;\n        }\n        this.plannedInterval = window.setTimeout(this.executeInterval.bind(this), 5000);\n    }\n\n    private stopInterval() {\n        if (this.plannedInterval === null) {\n            return;\n        }\n        window.clearTimeout(this.plannedInterval);\n        this.plannedInterval = null;\n    }\n\n    private initUpdateWidget() {\n        this.$updateWidget = this.$widget.find('.autoUpdateWidget');\n        this.$proposalList = this.$widget.find('.reloadContent');\n        this.$dateField = this.$widget.find('.currentDate .date');\n        this.updateUrl = this.$widget.data('reload-url');\n\n        let $toggle = this.$updateWidget.find('#autoUpdateToggle');\n        $toggle.on(\"change\", () => {\n            let active: boolean = $toggle.prop('checked');\n            if (active) {\n                this.reload(() => {});\n                this.startInterval();\n            } else {\n                this.stopInterval();\n            }\n        }).trigger('change');\n    }\n}\n"]}