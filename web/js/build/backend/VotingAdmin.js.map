{"version":3,"sources":["backend/VotingAdmin.js","backend/VotingAdmin.ts"],"names":["define","require","exports","Object","defineProperty","value","VotingAdmin","constructor","$element","this","element","createVueWidget","initVotingCreater","$","tooltip","vueEl","querySelector","voteSettingsUrl","getAttribute","voteCreateUrl","voteDownloadUrl","addableMotions","JSON","parse","pollUrl","votingInitJson","initUserGroups","widget","Vue","el","template","data","votingsJson","votings","userGroups","csrf","document","pollingId","computed","alreadyAddedItems","motions","amendments","forEach","voting","items","item","type","push","id","methods","_performOperation","votingBlockId","additionalProps","postData","_csrf","assign","url","replace","post","undefined","success","alert","message","catch","err","responseText","setVotingFromJson","setVotingFromObject","setStatus","newStatus","op","status","saveSettings","title","answerTemplate","majorityType","quorumType","votePolicy","resultsPublic","votesPublic","assignedMotion","deleteVoting","createVoting","answers","specificQuestion","window","setTimeout","scrollintoview","top_offset","removeItem","itemType","itemId","addIMotion","itemDefinition","addQuestion","question","setVotersToUserGroup","userIds","newUserGroup","reloadData","get","console","error","startPolling","setInterval","beforeDestroy","clearInterval","created","initPolicyWidget","$widget","$select","find","loadUrl","selectizeOption","loadThrottle","valueField","labelField","searchField","load","query","cb","then","res","selectize","$policySelect","on","parseInt","val","removeClass","addClass","trigger","opener","form","addEventListener","classList","remove","add","getRadioListValue","selector","defaultValue","querySelectorAll","input","checked","recalcQuestionListener","recalcAnswerTypeListener","ev","stopPropagation","preventDefault","assigned","map"],"mappings":"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","file":"VotingAdmin.js","sourcesContent":[null,"import { VueConstructor } from 'vue';\n\ndeclare var Vue: VueConstructor;\n\nconst POLICY_USER_GROUPS  = 6;\n\nexport class VotingAdmin {\n    private widget;\n    private element: HTMLElement;\n\n    constructor($element: JQuery) {\n        this.element = $element[0];\n        this.createVueWidget();\n        this.initVotingCreater();\n\n        $('[data-toggle=\"tooltip\"]').tooltip();\n    }\n\n    private createVueWidget() {\n        const vueEl = this.element.querySelector(\".votingAdmin\");\n        const voteSettingsUrl = this.element.getAttribute('data-url-vote-settings');\n        const voteCreateUrl = this.element.getAttribute('data-vote-create');\n        const voteDownloadUrl = this.element.getAttribute('data-url-vote-download');\n        const addableMotions = JSON.parse(this.element.getAttribute('data-addable-motions'));\n        const pollUrl = this.element.getAttribute('data-url-poll');\n        const votingInitJson = this.element.getAttribute('data-voting');\n        const initUserGroups = JSON.parse(this.element.getAttribute('data-user-groups'));\n\n        this.widget = new Vue({\n            el: vueEl,\n            template: `<div class=\"adminVotings\">\n                <voting-admin-widget v-for=\"voting in votings\"\n                                     :voting=\"voting\"\n                                     :addableMotions=\"addableMotions\"\n                                     :alreadyAddedItems=\"alreadyAddedItems\"\n                                     :userGroups=\"userGroups\"\n                                     :voteDownloadUrl=\"voteDownloadUrl\"\n                                     @set-status=\"setStatus\"\n                                     @save-settings=\"saveSettings\"\n                                     @remove-item=\"removeItem\"\n                                     @delete-voting=\"deleteVoting\"\n                                     @add-imotion=\"addIMotion\"\n                                     @add-question=\"addQuestion\"\n                                     @set-voters-to-user-group=\"setVotersToUserGroup\"\n                                     ref=\"voting-admin-widget\"\n                ></voting-admin-widget>\n            </div>`,\n            data() {\n                return {\n                    votingsJson: null,\n                    votings: null,\n                    userGroups: initUserGroups,\n                    voteDownloadUrl,\n                    addableMotions,\n                    csrf: document.querySelector('head meta[name=csrf-token]').getAttribute('content'),\n                    pollingId: null\n                };\n            },\n            computed: {\n                alreadyAddedItems: function () {\n                    const motions = [];\n                    const amendments = [];\n                    this.votings.forEach(voting => {\n                        voting.items.forEach(item => {\n                            if (item.type === 'motion') {\n                                motions.push(item.id);\n                            }\n                            if (item.type === 'amendment') {\n                                amendments.push(item.id);\n                            }\n                        });\n                    });\n                    return {motions, amendments};\n                }\n            },\n            methods: {\n                _performOperation: function (votingBlockId, additionalProps) {\n                    let postData = {\n                        _csrf: this.csrf,\n                    };\n                    if (additionalProps) {\n                        postData = Object.assign(postData, additionalProps);\n                    }\n                    const widget = this;\n                    const url = voteSettingsUrl.replace(/VOTINGBLOCKID/, votingBlockId);\n                    $.post(url, postData, function (data) {\n                        if (data.success !== undefined && !data.success) {\n                            alert(data.message);\n                            return;\n                        }\n                        widget.votings = data;\n                    }).catch(function (err) {\n                        alert(err.responseText);\n                    });\n                },\n                setVotingFromJson(data) {\n                    if (data === this.votingsJson) {\n                        return;\n                    }\n                    this.votings = JSON.parse(data);\n                    this.votingsJson = data;\n                },\n                setVotingFromObject(data) {\n                    this.votings = data;\n                    this.votingsJson = null;\n                },\n                setStatus(votingBlockId, newStatus) {\n                    this._performOperation(votingBlockId, {\n                        op: 'update-status',\n                        status: newStatus,\n                    });\n                },\n                saveSettings(votingBlockId, title, answerTemplate, majorityType, quorumType, votePolicy, resultsPublic, votesPublic, assignedMotion) {\n                    this._performOperation(votingBlockId, {\n                        op: 'save-settings',\n                        title,\n                        answerTemplate,\n                        majorityType,\n                        quorumType,\n                        votePolicy,\n                        resultsPublic,\n                        votesPublic,\n                        assignedMotion,\n                    });\n                },\n                deleteVoting(votingBlockId) {\n                    this._performOperation(votingBlockId, {\n                        op: 'delete-voting',\n                    });\n                },\n                createVoting: function (type, answers, title, specificQuestion, assignedMotion, majorityType, votePolicy, userGroups, resultsPublic, votesPublic) {\n                    let postData = {\n                        _csrf: this.csrf,\n                        type,\n                        answers,\n                        title,\n                        specificQuestion,\n                        assignedMotion,\n                        majorityType,\n                        votePolicy,\n                        userGroups,\n                        resultsPublic,\n                        votesPublic\n                    };\n\n                    const widget = this;\n                    $.post(voteCreateUrl, postData, function (data) {\n                        if (data.success !== undefined && !data.success) {\n                            alert(data.message);\n                            return;\n                        }\n                        widget.votings = data['votings'];\n\n                        window.setTimeout(() => {\n                            $(\"#voting\" + data['created_voting']).scrollintoview({top_offset: -100});\n                        }, 200);\n                    }).catch(function (err) {\n                        alert(err.responseText);\n                    });\n                },\n                removeItem(votingBlockId, itemType, itemId) {\n                    this._performOperation(votingBlockId, {\n                        op: 'remove-item',\n                        itemType,\n                        itemId\n                    });\n                },\n                addIMotion(votingBlockId, itemDefinition) {\n                    this._performOperation(votingBlockId, {\n                        op: 'add-imotion',\n                        itemDefinition\n                    });\n                },\n                addQuestion(votingBlockId, question) {\n                    this._performOperation(votingBlockId, {\n                        op: 'add-question',\n                        question\n                    });\n                },\n                setVotersToUserGroup(votingBlockId, userIds, newUserGroup) {\n                    this._performOperation(votingBlockId, {\n                        op: 'set-voters-to-user-group',\n                        userIds,\n                        newUserGroup\n                    });\n                },\n                reloadData: function () {\n                    const widget = this;\n                    $.get(pollUrl, function (data) {\n                        widget.setVotingFromJson(data);\n                    }, 'text').catch(function (err) {\n                        console.error(\"Could not load voting data from backend\", err);\n                    });\n                },\n                startPolling: function () {\n                    const widget = this;\n                    this.pollingId = window.setInterval(function () {\n                        widget.reloadData();\n                    }, 3000);\n                }\n            },\n            beforeDestroy() {\n                window.clearInterval(this.pollingId)\n            },\n            created() {\n                this.setVotingFromJson(votingInitJson);\n                this.startPolling()\n            }\n        });\n\n        // Used by tests to control vue-select\n        window['votingAdminWidget'] = this.widget;\n    }\n\n    private initPolicyWidget() {\n        const $widget = $(this.element);\n        const $select: any = $widget.find('.userGroupSelect'),\n            loadUrl = $select.data('load-url');\n        let selectizeOption = {};\n        if (loadUrl) {\n            selectizeOption = Object.assign(selectizeOption, {\n                loadThrottle: null,\n                valueField: 'id',\n                labelField: 'label',\n                searchField: 'label',\n                load: function (query, cb) {\n                    if (!query) return cb();\n                    return $.get(loadUrl, {query}).then(res => {\n                        cb(res);\n                    });\n                }\n            });\n        }\n        $select.find(\"select\").selectize(selectizeOption);\n\n        const $policySelect = $widget.find(\".policySelect\");\n        $policySelect.on(\"change\", () => {\n            if (parseInt($policySelect.val() as string, 10) === POLICY_USER_GROUPS) {\n                $select.removeClass(\"hidden\");\n            } else {\n                $select.addClass(\"hidden\");\n            }\n        }).trigger(\"change\");\n    }\n\n    private initVotingCreater() {\n        const opener = this.element.querySelector('.createVotingOpener'),\n            form = this.element.querySelector('.createVotingHolder'),\n            specificQuestion = this.element.querySelector('.specificQuestion'),\n            majorityType = this.element.querySelector('.majorityTypeSettings');\n        opener.addEventListener('click', () => {\n            form.classList.remove('hidden');\n            opener.classList.add('hidden');\n        });\n\n        const getRadioListValue = (selector: string, defaultValue: string) => {\n            let val = defaultValue;\n            form.querySelectorAll(selector).forEach(el => {\n                const input = el as HTMLInputElement;\n                if (input.checked) {\n                    val = input.value;\n                }\n            });\n            return val;\n        };\n\n        const recalcQuestionListener = () => {\n            if (getRadioListValue('.votingType input', 'question') === 'question') {\n                specificQuestion.classList.remove('hidden');\n            } else {\n                specificQuestion.classList.add('hidden');\n            }\n        };\n        form.querySelectorAll('.votingType input').forEach(el => {\n            el.addEventListener('change', recalcQuestionListener);\n        });\n        recalcQuestionListener();\n\n        const recalcAnswerTypeListener = () => {\n            if (getRadioListValue('.answerTemplate input', '0') === '2') {\n                majorityType.classList.add('hidden');\n            } else {\n                majorityType.classList.remove('hidden');\n\n            }\n        };\n        form.querySelectorAll('.answerTemplate input').forEach(el => {\n            el.addEventListener('change', recalcAnswerTypeListener);\n        });\n        recalcAnswerTypeListener();\n\n        this.initPolicyWidget();\n\n        form.querySelector('form').addEventListener('submit', (ev) => {\n            ev.stopPropagation();\n            ev.preventDefault();\n            const type = getRadioListValue('.votingType input', 'question');\n            const answers = parseInt(getRadioListValue('.answerTemplate input', '0'), 10); // Default\n            const title = form.querySelector('.settingsTitle') as HTMLInputElement;\n            const specificQuestion = form.querySelector('.settingsQuestion') as HTMLInputElement;\n            const assigned = form.querySelector('.settingsAssignedMotion') as HTMLSelectElement;\n            const majorityType = parseInt(getRadioListValue('.majorityTypeSettings input', '1'), 10); // Default: simple majority\n            const resultsPublic = parseInt(getRadioListValue('.resultsPublicSettings input', '1'), 10); // Default: everyone\n            const votesPublic = parseInt(getRadioListValue('.votesPublicSettings input', '0'), 10); // Default: nobody\n            const votePolicy = parseInt((form.querySelector('.policySelect') as HTMLSelectElement).value, 10);\n            let userGroups;\n            if (votePolicy === POLICY_USER_GROUPS) {\n                userGroups = (form.querySelector('.userGroupSelectList') as any).selectize.items.map(item => parseInt(item, 10));\n            } else {\n                userGroups = [];\n            }\n            this.widget.createVoting(type, answers, title.value, specificQuestion.value, assigned.value, majorityType, votePolicy, userGroups, resultsPublic, votesPublic);\n\n            form.classList.add('hidden');\n            opener.classList.remove('hidden');\n        });\n    }\n}\n"]}