{"version":3,"sources":["backend/VotingAdmin.js","backend/VotingAdmin.ts"],"names":["define","require","exports","Object","defineProperty","value","VotingAdmin","constructor","$element","this","element","createVueWidget","initVotingCreater","vueEl","querySelector","voteSettingsUrl","getAttribute","voteCreateUrl","addableMotions","JSON","parse","pollUrl","votingInitJson","widget","Vue","el","template","data","votingsJson","votings","csrf","document","pollingId","computed","alreadyAddedItems","motions","amendments","forEach","voting","items","item","type","push","id","methods","_performOperation","votingBlockId","additionalProps","postData","_csrf","assign","url","replace","$","post","undefined","success","alert","message","catch","err","responseText","setVotingFromJson","setVotingFromObject","setStatus","newStatus","organizations","op","status","map","orga","members_present","saveSettings","title","majorityType","resultsPublic","votesPublic","assignedMotion","deleteVoting","createVoting","window","setTimeout","scrollintoview","top_offset","removeItem","itemType","itemId","addItem","itemDefinition","reloadData","get","console","error","startPolling","setInterval","beforeDestroy","clearInterval","created","opener","form","addEventListener","classList","remove","add","ev","stopPropagation","preventDefault","assigned"],"mappings":"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","file":"VotingAdmin.js","sourcesContent":[null,"import { VueConstructor } from 'vue';\n\ndeclare var Vue: VueConstructor;\n\nexport class VotingAdmin {\n    private widget;\n    private element: HTMLElement;\n\n    constructor($element: JQuery) {\n        this.element = $element[0];\n        this.createVueWidget();\n        this.initVotingCreater();\n    }\n\n    private createVueWidget() {\n        const vueEl = this.element.querySelector(\".votingAdmin\");\n        const voteSettingsUrl = this.element.getAttribute('data-url-vote-settings');\n        const voteCreateUrl = this.element.getAttribute('data-vote-create');\n        const addableMotions = JSON.parse(this.element.getAttribute('data-addable-motions'));\n        const pollUrl = this.element.getAttribute('data-url-poll');\n        const votingInitJson = this.element.getAttribute('data-voting');\n\n        this.widget = new Vue({\n            el: vueEl,\n            template: `<div class=\"adminVotings\">\n                <voting-admin-widget v-for=\"voting in votings\"\n                                     :voting=\"voting\"\n                                     :addableMotions=\"addableMotions\"\n                                     :alreadyAddedItems=\"alreadyAddedItems\"\n                                     @set-status=\"setStatus\"\n                                     @save-settings=\"saveSettings\"\n                                     @remove-item=\"removeItem\"\n                                     @delete-voting=\"deleteVoting\"\n                                     @add-item=\"addItem\"\n                ></voting-admin-widget>\n            </div>`,\n            data() {\n                return {\n                    votingsJson: null,\n                    votings: null,\n                    addableMotions,\n                    csrf: document.querySelector('head meta[name=csrf-token]').getAttribute('content'),\n                    pollingId: null\n                };\n            },\n            computed: {\n                alreadyAddedItems: function () {\n                    const motions = [];\n                    const amendments = [];\n                    this.votings.forEach(voting => {\n                        voting.items.forEach(item => {\n                            if (item.type === 'motion') {\n                                motions.push(item.id);\n                            }\n                            if (item.type === 'amendment') {\n                                amendments.push(item.id);\n                            }\n                        });\n                    });\n                    return {motions, amendments};\n                }\n            },\n            methods: {\n                _performOperation: function (votingBlockId, additionalProps) {\n                    let postData = {\n                        _csrf: this.csrf,\n                    };\n                    if (additionalProps) {\n                        postData = Object.assign(postData, additionalProps);\n                    }\n                    const widget = this;\n                    const url = voteSettingsUrl.replace(/VOTINGBLOCKID/, votingBlockId);\n                    $.post(url, postData, function (data) {\n                        if (data.success !== undefined && !data.success) {\n                            alert(data.message);\n                            return;\n                        }\n                        widget.votings = data;\n                    }).catch(function (err) {\n                        alert(err.responseText);\n                    });\n                },\n                setVotingFromJson(data) {\n                    if (data === this.votingsJson) {\n                        return;\n                    }\n                    this.votings = JSON.parse(data);\n                    this.votingsJson = data;\n                },\n                setVotingFromObject(data) {\n                    this.votings = data;\n                    this.votingsJson = null;\n                },\n                setStatus(votingBlockId, newStatus, organizations) {\n                    this._performOperation(votingBlockId, {\n                        op: 'update-status',\n                        status: newStatus,\n                        organizations: organizations.map(orga => { return {\n                            id: orga.id,\n                            members_present: orga.members_present,\n                        }}),\n                    });\n                },\n                saveSettings(votingBlockId, title, majorityType, resultsPublic, votesPublic, assignedMotion) {\n                    this._performOperation(votingBlockId, {\n                        op: 'save-settings',\n                        title,\n                        majorityType,\n                        resultsPublic,\n                        votesPublic,\n                        assignedMotion,\n                    });\n                },\n                deleteVoting(votingBlockId) {\n                    this._performOperation(votingBlockId, {\n                        op: 'delete-voting',\n                    });\n                },\n                createVoting: function (title, assignedMotion) {\n                    let postData = {\n                        _csrf: this.csrf,\n                        title,\n                        assignedMotion\n                    };\n                    const widget = this;\n                    $.post(voteCreateUrl, postData, function (data) {\n                        if (data.success !== undefined && !data.success) {\n                            alert(data.message);\n                            return;\n                        }\n                        widget.votings = data['votings'];\n\n                        window.setTimeout(() => {\n                            $(\"#voting\" + data['created_voting']).scrollintoview({top_offset: -100});\n                        }, 200);\n                    }).catch(function (err) {\n                        alert(err.responseText);\n                    });\n                },\n                removeItem(votingBlockId, itemType, itemId) {\n                    this._performOperation(votingBlockId, {\n                        op: 'remove-item',\n                        itemType,\n                        itemId\n                    });\n                },\n                addItem(votingBlockId, itemDefinition) {\n                    this._performOperation(votingBlockId, {\n                        op: 'add-item',\n                        itemDefinition\n                    });\n                },\n                reloadData: function () {\n                    const widget = this;\n                    $.get(pollUrl, function (data) {\n                        widget.setVotingFromJson(data);\n                    }, 'text').catch(function (err) {\n                        console.error(\"Could not load voting data from backend\", err);\n                    });\n                },\n                startPolling: function () {\n                    const widget = this;\n                    this.pollingId = window.setInterval(function () {\n                        widget.reloadData();\n                    }, 3000);\n                }\n            },\n            beforeDestroy() {\n                window.clearInterval(this.pollingId)\n            },\n            created() {\n                this.setVotingFromJson(votingInitJson);\n                this.startPolling()\n            }\n        });\n    }\n\n    private initVotingCreater() {\n        const opener = this.element.querySelector('.createVotingOpener'),\n            form = this.element.querySelector('.createVotingHolder');\n        opener.addEventListener('click', () => {\n            form.classList.remove('hidden');\n            opener.classList.add('hidden');\n        });\n        form.querySelector('form').addEventListener('submit', (ev) => {\n            ev.stopPropagation();\n            ev.preventDefault();\n            const title = form.querySelector('.settingsTitle') as HTMLInputElement;\n            const assigned = form.querySelector('.settingsAssignedMotion') as HTMLSelectElement;\n            this.widget.createVoting(title.value, assigned.value);\n\n            form.classList.add('hidden');\n            opener.classList.remove('hidden');\n        });\n    }\n}\n"]}