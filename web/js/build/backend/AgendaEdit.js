define(["require","exports"],function(e,a){"use strict";Object.defineProperty(a,"__esModule",{value:!0});var t=function(){function e(e){var t=this;this.$widget=e,this.delAgendaItemStr='<a href="#" class="delAgendaItem"><span class="glyphicon glyphicon-minus-sign"></span></a>',this.$agenda=$(".motionListWithinAgenda"),this.locale=$("html").attr("lang"),this.$agenda.addClass("agendaListEditing"),this.$agenda.nestedSortable({handle:".moveHandle",items:"li.agendaItem",toleranceElement:"> div",placeholder:"movePlaceholder",tolerance:"pointer",forcePlaceholderSize:!0,helper:"clone",axis:"y",update:function(){$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change"),t.saveNewOrder()}}),this.$agenda.find(".agendaItem").each(function(e,a){t.prepareAgendaItem($(a))}),this.prepareAgendaList(this.$agenda,!0),this.$agenda.on("click",".agendaItemAdder .addEntry",this.agendaItemAdd.bind(this)),this.$agenda.on("click",".agendaItemAdder .addDate",this.agendaDateAdd.bind(this)),this.$agenda.on("change",".agendaItemAdder .showTimes input",this.showTimesChanges.bind(this)),this.$agenda.on("click",".delAgendaItem",this.delAgendaItem.bind(this)),this.$agenda.on("click",".editAgendaItem",this.editAgendaItem.bind(this)),this.$agenda.on("submit",".agendaItemEditForm",this.submitSingleItemForm.bind(this)),this.$agenda.on("submit",".agendaDateEditForm",this.submitSingleItemForm.bind(this))}return e.prototype.buildAgendaStruct=function(e){var n=this,i=[];return e.children(".agendaItem").each(function(e,a){var t=$(a);0<t.find("> div > .agendaDateEditForm").length?i.push({type:"date",id:parseInt(t.data("id")),children:n.buildAgendaStruct(t.find("> ol"))}):i.push({type:"std",id:parseInt(t.data("id")),children:n.buildAgendaStruct(t.find("> ol"))})}),i},e.prototype.saveNewOrder=function(){var e=this.$widget.data("save-order"),a=this.buildAgendaStruct(this.$widget.find("> ol"));console.log("Save new order: "+e,a),$.post(e,{_csrf:$("input[name=_csrf]").val(),data:JSON.stringify(a)},function(e){e.success||alert("Could not save: "+e.message)})},e.prototype.submitSingleItemForm=function(e){var t=this;e.preventDefault();var n=$(e.target).parents("li.agendaItem").first(),a=n.parents("li").first(),i=n.prevAll().length,d=0<a.length?a.data("id"):null,s=$(e.target),r=n.data("save-url"),o={parentId:d,position:i,title:s.find("input[name=title]").val()};if(n.hasClass("agendaItemDate")){o.type="date";var l=s.find(".date").datetimepicker("date");o.date=l?l.format("YYYY-MM-DD"):null}else o.type="agendaItem",o.inProposedProcedures=s.find("input[name=inProposedProcedures]").prop("checked"),o.motionType=parseInt(s.find("select[name=motionType]").val()),o.time=s.find("input[name=time]").val(),o.code=s.find("input[name=code]").val();$.post(r,{_csrf:$("input[name=_csrf]").val(),data:JSON.stringify(o)},function(e){if(e.success){var a=$(e.html);n.replaceWith(a),t.prepareAgendaItem(a),$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change")}else alert("Could not save: "+e.message)})},e.prototype.delAgendaItem=function(e){e.preventDefault();var a=$(e.target).parents("li.agendaItem").first(),t=a.data("del-url");bootbox.confirm(__t("admin","agendaDelEntryConfirm"),function(e){e&&$.post(t,{_csrf:$("input[name=_csrf]").val()},function(e){e.success?(a.remove(),$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change")):alert("Could not delete: "+e.message)})})},e.prototype.editAgendaItem=function(e){e.preventDefault();var a=$(e.target).parents("li.agendaItem").first();a.addClass("editing"),a.find("> div > .agendaItemEditForm input[name=code]").trigger("focus").trigger("select")},e.prototype.agendaItemAdd=function(e){e.preventDefault();var a=$($("#agendaNewElementTemplate").val());$(e.target).parents(".agendaItemAdder").first().before(a),this.prepareAgendaItem(a),a.find(".editAgendaItem").trigger("click"),a.find(".agendaItemEditForm input.code").trigger("focus")},e.prototype.agendaDateAdd=function(e){e.preventDefault();var a=$($("#agendaNewDateTemplate").val());$(e.target).parents(".agendaItemAdder").first().before(a),this.prepareAgendaItem(a),a.find(".editAgendaItem").trigger("click")},e.prototype.showTimesChanges=function(){this.$widget.find(".agendaItemAdder .showTimes input").prop("checked")?this.$agenda.addClass("showTimes").removeClass("noShowTimes"):this.$agenda.removeClass("showTimes").addClass("noShowTimes")},e.prototype.prepareAgendaItem=function(e){var n=this;e.find("> div").prepend('<span class="glyphicon glyphicon-resize-vertical moveHandle"></span>'),e.find("> div > h3").append('<a href="#" class="editAgendaItem"><span class="glyphicon glyphicon-pencil"></span></a>'),e.find("> div > h3").append(this.delAgendaItemStr),e.find("> div li.checkbox").on("click",function(e){e.stopPropagation()}),e.find("> ol.agenda").each(function(e,a){n.prepareAgendaList($(a),!1)}),e.find("> div .input-group.time").datetimepicker({locale:this.locale,format:"LT"}),e.find("> div .input-group.date").each(function(e,a){var t=null;$(a).data("date")&&(t=moment($(a).data("date"),"YYYY-MM-DD",n.locale)),$(a).datetimepicker({locale:n.locale,format:"dddd, Do MMMM YYYY",defaultDate:t})})},e.prototype.prepareAgendaList=function(e,a){var t='<li class="agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled"><a href="#" class="addEntry"><span class="glyphicon glyphicon-plus-sign"></span> '+__t("admin","agendaAddEntry")+"</a>";a&&(t+='<a href="#" class="addDate"><span class="glyphicon glyphicon-plus-sign"></span> '+__t("admin","agendaAddDate")+'</a><span class="spacer"></span><label class="showTimes"><input type="checkbox" class="showTimes"> '+__t("admin","agendaShowTimes")+"</label>"),t+="</li>";var n=$(t);this.$agenda.hasClass("showTimes")&&n.find(".showTimes input").prop("checked",!0),e.append(n)},e}();a.AgendaEdit=t});
//# sourceMappingURL=AgendaEdit.js.map
