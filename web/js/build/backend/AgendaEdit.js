define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function t(e){var n=this;this.$widget=e,this.hasChanged=!1,this.delAgendaItemStr='<a href="#" class="delAgendaItem"><span class="glyphicon glyphicon-minus-sign"></span></a>',this.$agendaform=$("#agendaEditSavingHolder"),this.$agenda=$(".motionListWithinAgenda"),this.$agenda.addClass("agendaListEditing"),this.$agenda.nestedSortable({handle:".moveHandle",items:"li.agendaItem",toleranceElement:"> div",placeholder:"movePlaceholder",tolerance:"pointer",forcePlaceholderSize:!0,helper:"clone",axis:"y",update:function(){n.showSaver(),$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change")}}),this.$agenda.find(".agendaItem").each(function(e,t){n.prepareAgendaItem($(t))}),this.prepareAgendaList(this.$agenda,!0),this.$agenda.find("ol.agenda").each(function(e,t){n.prepareAgendaList($(t),!1)}),this.locale=$("html").attr("lang"),this.$agenda.find(".input-group.time").datetimepicker({locale:this.locale,format:"LT",stepping:5}),this.$agenda.find(".input-group.date").each(function(e,t){var a=null;$(t).data("date")&&(a=moment($(t).data("date"),"YYYY-MM-DD",n.locale)),$(t).datetimepicker({locale:n.locale,format:"dddd, Do MMMM YYYY",defaultDate:a})}),this.$agenda.on("click",".agendaItemAdder .addEntry",this.agendaItemAdd.bind(this)),this.$agenda.on("click",".agendaItemAdder .addDate",this.agendaDateAdd.bind(this)),this.$agenda.on("change",".agendaItemAdder .showTimes input",this.showTimesChanges.bind(this)),this.$agenda.on("click",".delAgendaItem",this.delAgendaItem.bind(this)),this.$agenda.on("click",".editAgendaItem",this.editAgendaItem.bind(this)),this.$agenda.on("submit",".agendaItemEditForm",this.submitSingleItemForm.bind(this)),this.$agenda.on("submit",".agendaDateEditForm",this.submitDateItemForm.bind(this)),this.$agendaform.on("submit",this.submitCompleteForm.bind(this))}return t.prototype.buildAgendaStruct=function(e){var o=this,r=[];return e.children(".agendaItem").each(function(e,t){var a=$(t),n=a.attr("id").split("_");if(0<a.find("> div > .agendaDateEditForm").length){var i=a.find("> div > .agendaDateEditForm input[name=date]").val();r.push({type:"date",id:n[1],date:moment(i,"dddd, Do MMMM YYYY",o.locale).format("L"),title:a.find("> div > .agendaDateEditForm input[name=title]").val(),children:o.buildAgendaStruct(a.find("> ol"))})}else{var d=a.find("> div > .agendaItemEditForm"),s=null;o.$widget.find(".agendaItemAdder .showTimes input").prop("checked")&&(s=a.find("> div > .agendaItemEditForm input[name=time]").val()),r.push({type:"std",id:n[1],time:s,code:d.find("input[name=code]").val(),title:d.find("input[name=title]").val(),motionTypeId:d.find("select[name=motionType]").val(),inProposedProcedures:d.find(".extraSettings input[name=inProposedProcedures]").prop("checked"),children:o.buildAgendaStruct(a.find("> ol"))})}}),r},t.prototype.submitDateItemForm=function(e){e.preventDefault(),this.showSaver();var t=$(e.target).parents("li.agendaItem").first(),a=$(e.target),n=a.find("input[name=title]").val(),i=a.find("input[name=date]").val(),d="";i&&(d+=i),i&&n&&(d+=": "),n&&(d+=n),t.removeClass("editing"),t.find("> div > h3 .title").text(d),$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change")},t.prototype.submitSingleItemForm=function(e){var t=this;e.preventDefault(),this.showSaver();var a=$(e.target).parents("li.agendaItem").first(),n=$(e.target),i=n.find("input[name=title]").val(),d=n.find("input[name=code]").val(),s=n.find("input[name=time]").val(),o=a.data("save-url");$.post(o,{_csrf:$("input[name=_csrf]").val(),data:JSON.stringify({type:"agendaItem",title:n.find("input[name=title]").val(),code:n.find("input[name=code]").val(),time:n.find("input[name=time]").val(),motionType:parseInt(n.find("select[name=motionType]").val()),inProposedProcedures:n.find("input[name=inProposedProcedures]").prop("checked")})},function(e){a.removeClass("editing"),a.data("code",d),a.find("> div > h3 .code").text(d),a.find("> div > h3 .title").text(i),t.$widget.find(".agendaItemAdder .showTimes input").prop("checked")&&s?(0===a.find("> div > h3 .time").length&&(console.log("prepend"),a.find("> div > h3").prepend('<span class="time"></span>')),a.find("> div > h3 .time").text(s)):a.find("> div > h3 .time").remove(),$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change")})},t.prototype.submitCompleteForm=function(){var e=this.buildAgendaStruct($(".motionListWithinAgenda"));this.$agendaform.find("input[name=data]").val(JSON.stringify(e)),$(window).off("beforeunload",t.onLeavePage)},t.prototype.delAgendaItem=function(e){var t=this,a=$(e.target);e.preventDefault(),bootbox.confirm(__t("admin","agendaDelEntryConfirm"),function(e){e&&(t.showSaver(),a.parents("li.agendaItem").first().remove(),$("ol.motionListWithinAgenda").trigger("antragsgruen:agenda-change"))})},t.prototype.editAgendaItem=function(e){e.preventDefault(),this.showSaver();var t=$(e.target).parents("li.agendaItem").first();t.addClass("editing"),t.find("> div > .agendaItemEditForm input[name=code]").trigger("focus").trigger("select")},t.prototype.agendaItemAdd=function(e){e.preventDefault(),this.showSaver();var t=$($("#agendaNewElementTemplate").val());$(e.target).parents(".agendaItemAdder").first().before(t),this.prepareAgendaItem(t),this.prepareAgendaList(t.find("ol.agenda"),!1),t.find(".editAgendaItem").trigger("click"),t.find(".agendaItemEditForm input.code").trigger("focus"),t.find(".input-group.time").datetimepicker({locale:this.locale,format:"LT"})},t.prototype.agendaDateAdd=function(e){e.preventDefault(),this.showSaver();var t=$($("#agendaNewDateTemplate").val());$(e.target).parents(".agendaItemAdder").first().before(t),this.prepareAgendaItem(t),this.prepareAgendaList(t.find("ol.agenda"),!1),t.find(".editAgendaItem").trigger("click"),t.find(".input-group.date").datetimepicker({locale:this.locale,format:"dddd, Do MMMM YYYY"})},t.prototype.showTimesChanges=function(){this.$widget.find(".agendaItemAdder .showTimes input").prop("checked")?this.$agenda.addClass("showTimes").removeClass("noShowTimes"):this.$agenda.removeClass("showTimes").addClass("noShowTimes")},t.prototype.prepareAgendaItem=function(e){e.find("> div").prepend('<span class="glyphicon glyphicon-resize-vertical moveHandle"></span>'),e.find("> div > h3").append('<a href="#" class="editAgendaItem"><span class="glyphicon glyphicon-pencil"></span></a>'),e.find("> div > h3").append(this.delAgendaItemStr),e.find("li.checkbox").on("click",function(e){e.stopPropagation()})},t.prototype.prepareAgendaList=function(e,t){var a='<li class="agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled"><a href="#" class="addEntry"><span class="glyphicon glyphicon-plus-sign"></span> '+__t("admin","agendaAddEntry")+"</a>";t&&(a+='<a href="#" class="addDate"><span class="glyphicon glyphicon-plus-sign"></span> '+__t("admin","agendaAddDate")+'</a><span class="spacer"></span><label class="showTimes"><input type="checkbox" class="showTimes"> '+__t("admin","agendaShowTimes")+"</label>"),a+="</li>";var n=$(a);this.$agenda.hasClass("showTimes")&&n.find(".showTimes input").prop("checked",!0),e.append(n)},t.prototype.showSaver=function(){$("#agendaEditSavingHolder").removeClass("hidden"),this.hasChanged=!0,$("body").hasClass("testing")||$(window).on("beforeunload",t.onLeavePage)},t.onLeavePage=function(){return __t("std","leave_changed_page")},t}();t.AgendaEdit=a});
//# sourceMappingURL=AgendaEdit.js.map
