{"version":3,"sources":["backend/AgendaEdit.ts"],"names":["AgendaEdit","_this","this","hasChanged","delAgendaItemStr","$agendaform","$","$agenda","addClass","nestedSortable","handle","items","toleranceElement","placeholder","tolerance","forcePlaceholderSize","helper","axis","update","showSaver","trigger","find","each","i","el","prepareAgendaItem","prepareAgendaList","on","agendaItemAdd","bind","delAgendaItem","editAgendaItem","submitSingleItemForm","submit","submitCompleteForm","prototype","buildAgendaStruct","$ol","children","$li","id","attr","split","push","code","val","title","motionTypeId","ev","preventDefault","target","parents","first","$form","newTitle","newCode","removeClass","data","text","JSON","stringify","window","off","onLeavePage","$this","bootbox","confirm","__t","result","remove","focus","select","$newElement","before","$item","prepend","append","$list","hasClass"],"mappings":"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","file":"AgendaEdit.js","sourcesContent":["/// <reference path=\"../typings/nestedSortable/index.d.ts\" />\n\nclass AgendaEdit {\n    private hasChanged: boolean = false;\n    private $agendaform: JQuery;\n\n    private delAgendaItemStr = '<a href=\"#\" class=\"delAgendaItem\"><span class=\"glyphicon glyphicon-minus-sign\"></span></a>';\n\n    constructor() {\n        this.$agendaform = $('#agendaEditSavingHolder');\n        let $agenda = $('.motionListAgenda');\n\n        $agenda.addClass('agendaListEditing');\n        $agenda.nestedSortable({\n            handle: '.moveHandle',\n            items: 'li.agendaItem',\n            toleranceElement: '> div',\n            placeholder: 'movePlaceholder',\n            tolerance: 'pointer',\n            forcePlaceholderSize: true,\n            helper: 'clone',\n            axis: 'y',\n            update: () => {\n                this.showSaver();\n                $('ol.motionListAgenda').trigger(\"antragsgruen:agenda-change\");\n            }\n        });\n        $agenda.find('.agendaItem').each((i, el) => {\n            this.prepareAgendaItem($(el));\n        });\n        this.prepareAgendaList($agenda);\n        $agenda.find('ol.agenda').each((i, el) => {\n            this.prepareAgendaList($(el));\n        });\n\n        $agenda.on('click', '.agendaItemAdder a', this.agendaItemAdd.bind(this));\n        $agenda.on('click', '.delAgendaItem', this.delAgendaItem.bind(this));\n        $agenda.on('click', '.editAgendaItem', this.editAgendaItem.bind(this));\n        $agenda.on('submit', '.agendaItemEditForm', this.submitSingleItemForm.bind(this));\n        this.$agendaform.submit(this.submitCompleteForm.bind(this));\n    }\n\n    buildAgendaStruct($ol) {\n        let items = [];\n        $ol.children('.agendaItem').each((i, el) => {\n            let $li = $(el),\n                id = $li.attr('id').split('_');\n            items.push({\n                'id': id[1],\n                'code': $li.find('> div > .agendaItemEditForm input[name=code]').val(),\n                'title': $li.find('> div > .agendaItemEditForm input[name=title]').val(),\n                'motionTypeId': $li.find('> div > .agendaItemEditForm select[name=motionType]').val(),\n                'children': this.buildAgendaStruct($li.find('> ol'))\n            });\n        });\n        return items;\n    }\n\n    submitSingleItemForm(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            $form = $(ev.target),\n            newTitle = $form.find('input[name=title]').val(),\n            newCode = $form.find('input[name=code]').val();\n        $li.removeClass('editing');\n        $li.data('code', newCode);\n        $li.find('> div > h3 .code').text(newCode);\n        $li.find('> div > h3 .title').text(newTitle);\n        $('ol.motionListAgenda').trigger(\"antragsgruen:agenda-change\");\n    }\n\n    submitCompleteForm() {\n        let data = this.buildAgendaStruct($('.motionListAgenda'));\n        this.$agendaform.find('input[name=data]').val(JSON.stringify(data));\n        $(window).off(\"beforeunload\", AgendaEdit.onLeavePage);\n    }\n\n    delAgendaItem(ev: Event) {\n        let $this = $(ev.target);\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"agendaDelEntryConfirm\"), (result) => {\n            if (result) {\n                this.showSaver();\n                $this.parents('li.agendaItem').first().remove();\n                $('ol.motionListAgenda').trigger(\"antragsgruen:agenda-change\");\n            }\n        });\n    }\n\n    editAgendaItem(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $li = $(ev.target).parents('li.agendaItem').first();\n        $li.addClass('editing');\n        $li.find('> div > .agendaItemEditForm input[name=code]').focus().select();\n    }\n\n    agendaItemAdd(ev: Event) {\n        ev.preventDefault();\n        this.showSaver();\n        let $newElement = $($('#agendaNewElementTemplate').val()),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        this.prepareAgendaList($newElement.find('ol.agenda'));\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find('.agendaItemEditForm input.code').focus();\n    }\n\n    prepareAgendaItem($item) {\n        $item.find('> div').prepend('<span class=\"glyphicon glyphicon-resize-vertical moveHandle\"></span>');\n        $item.find('> div > h3').append('<a href=\"#\" class=\"editAgendaItem\"><span class=\"glyphicon glyphicon-pencil\"></span></a>');\n        $item.find('> div > h3').append(this.delAgendaItemStr);\n    }\n\n    prepareAgendaList($list) {\n        $list.append(\n            '<li class=\"agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled\">' +\n            '<a href=\"#\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' +\n            __t('admin', 'agendaAddEntry') + '</a></li>'\n        );\n    }\n\n    showSaver() {\n        $('#agendaEditSavingHolder').removeClass(\"hidden\");\n        this.hasChanged = true;\n        if (!$(\"body\").hasClass('testing')) {\n            $(window).on(\"beforeunload\", AgendaEdit.onLeavePage);\n        }\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n}\n\nnew AgendaEdit();\n"]}