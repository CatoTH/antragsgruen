{"version":3,"sources":["backend/MotionEdit.ts"],"names":["MotionSupporterEdit","AntragsgruenEditor","STATUS_VOTE","STATUS_OBSOLETED_BY_MOTION","STATUS_OBSOLETED_BY_AMENDMENT","MotionEdit","constructor","lang","$","attr","this","$updateForm","$status","datetimepicker","locale","data","format","find","on","initMotionTextEdit","ev","preventDefault","loadAmendmentCollisions","each","text","CKEDITOR","instances","getData","parents","val","onSubmitDeleteForm","initProtocolFunctions","initVotingFunctions","initSlug","initStatus","addClass","removeClass","onChange","newStatus","parseInt","document","getElementById","value","console","log","querySelector","classList","add","remove","addEventListener","$classHolders","$closer","$textarea","editor","getEditor","parent","$opener","$votingBlockId","trigger","$select","currentTarget","selectedName","$votingItemBlockRow","length","confirmed","bootbox","confirm","__t","result","append","show","prop","hide","url","sections","$holder","children","$this","hasClass","sectionId","replace","post","newSections","_csrf","html","scrollintoview","top_offset"],"mappings":"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","file":"MotionEdit.js","sourcesContent":["import {MotionSupporterEdit} from \"./MotionSupporterEdit\";\nimport {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\n\nconst STATUS_VOTE = 11;\nconst STATUS_OBSOLETED_BY_MOTION = 32;\nconst STATUS_OBSOLETED_BY_AMENDMENT = 22;\n\nexport class MotionEdit {\n    private $updateForm: JQuery;\n    private $status: JQuery;\n\n    constructor() {\n        let lang = $(\"html\").attr(\"lang\");\n        this.$updateForm = $(\"#motionUpdateForm\");\n        this.$status = $(\"#motionStatus\");\n        $(\"#motionDateCreationHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDateSubmissionHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDatePublicationHolder\").datetimepicker({\n            locale: lang\n        });\n        $(\"#motionDateResolutionHolder\").datetimepicker({\n            locale: lang\n        });\n        $('#resolutionDateHolder').datetimepicker({\n            locale: $('#resolutionDate').data('locale'),\n            format: 'L'\n        });\n        $(\"#motionTextEditCaller\").find(\"button\").on('click', () => {\n            this.initMotionTextEdit();\n        });\n\n        $(\".checkAmendmentCollisions\").on('click', ev => {\n            ev.preventDefault();\n            this.loadAmendmentCollisions();\n        });\n\n        this.$updateForm.on(\"submit\", function () {\n            $(\".amendmentCollisionsHolder .amendmentOverrideBlock > .texteditor\").each(function () {\n                let text = CKEDITOR.instances[$(this).attr(\"id\")].getData();\n                $(this).parents(\".amendmentOverrideBlock\").find(\"> textarea\").val(text);\n            });\n        });\n\n        $(\".motionDeleteForm\").on(\"submit\", (ev, data) => {\n            this.onSubmitDeleteForm(ev, data);\n        });\n\n        this.initProtocolFunctions();\n        this.initVotingFunctions();\n        this.initSlug();\n        this.initStatus();\n\n        new MotionSupporterEdit($(\"#motionSupporterHolder\"));\n    }\n\n    private initSlug() {\n        $('.urlSlugHolder .shower button').on(\"click\", (ev) => {\n            ev.preventDefault();\n            $('.urlSlugHolder .shower').addClass('hidden');\n            $('.urlSlugHolder .holder').removeClass('hidden');\n        });\n    }\n    private initStatus() {\n        const onChange = () => {\n            const newStatus = parseInt((document.getElementById('motionStatus') as HTMLSelectElement).value, 10);\n            console.log(newStatus);\n            if (newStatus === STATUS_OBSOLETED_BY_MOTION) {\n                document.querySelector('.motionStatusString').classList.add('hidden');\n                document.querySelector('.motionStatusMotion').classList.remove('hidden');\n                document.querySelector('.motionStatusAmendment').classList.add('hidden');\n            } else if (newStatus === STATUS_OBSOLETED_BY_AMENDMENT) {\n                document.querySelector('.motionStatusString').classList.add('hidden');\n                document.querySelector('.motionStatusMotion').classList.add('hidden');\n                document.querySelector('.motionStatusAmendment').classList.remove('hidden');\n            } else {\n                document.querySelector('.motionStatusString').classList.remove('hidden');\n                document.querySelector('.motionStatusMotion').classList.add('hidden');\n                document.querySelector('.motionStatusAmendment').classList.add('hidden');\n            }\n        };\n        document.getElementById('motionStatus').addEventListener('change', onChange);\n        onChange();\n    }\n    private initProtocolFunctions() {\n        const $classHolders = $(\".contentProtocolCaller, .protocolHolder\"),\n            $closer = $(\".protocolCloser\"),\n            $opener = $(\".protocolOpener\");\n\n        $opener.on(\"click\", () => {\n            $classHolders.addClass('explicitlyOpened');\n        });\n        $closer.on(\"click\", () => {\n            $classHolders.removeClass('explicitlyOpened');\n        });\n\n        const $textarea = $(\"#protocol_text_wysiwyg\");\n        $textarea.attr(\"contenteditable\", \"true\");\n        const ckeditor = new AntragsgruenEditor($textarea.attr(\"id\"));\n        const editor = ckeditor.getEditor();\n\n        $textarea.parents(\"form\").on(\"submit\", () => {\n            $textarea.parent().find(\"textarea\").val(editor.getData());\n        });\n    }\n\n    private initVotingFunctions() {\n        const $classHolders = $(\".contentVotingResultCaller, .votingDataHolder\"),\n            $closer = $(\".votingDataCloser\"),\n            $opener = $(\".votingDataOpener\"),\n            $votingBlockId = $('select[name=votingBlockId]');\n\n        $opener.on(\"click\", () => {\n            $classHolders.addClass('explicitlyOpened');\n        });\n        $closer.on(\"click\", () => {\n            $classHolders.removeClass('explicitlyOpened');\n        });\n\n        this.$status.on('change', () => {\n            if (parseInt(this.$status.val() as string, 10) === STATUS_VOTE) {\n                $classHolders.addClass('hasVotingStatus');\n            } else {\n                $classHolders.removeClass('hasVotingStatus');\n            }\n        }).trigger('change');\n\n        $(\".votingItemBlockRow select\").on('change', (ev) => {\n            const $select = $(ev.currentTarget);\n            if ($select.val()) {\n                const selectedName = $select.find(\"option[value=\" + $select.val() + \"]\").data(\"group-name\");\n                $(\".votingItemBlockNameRow input\").val(selectedName);\n                $(\".votingItemBlockNameRow\").removeClass('hidden');\n            } else {\n                // Not grouped\n                $(\".votingItemBlockNameRow\").addClass('hidden');\n            }\n        });\n\n        $votingBlockId.on('change', () => {\n            if ($votingBlockId.val() === 'NEW') {\n                $(\".votingBlockRow .newBlock\").removeClass('hidden');\n                $(\".votingItemBlockRow\").addClass('hidden');\n                $(\".votingItemBlockNameRow\").addClass('hidden');\n            } else {\n                $(\".votingBlockRow .newBlock\").addClass('hidden');\n                $(\".votingItemBlockRow\").addClass('hidden');\n                const $votingItemBlockRow = $(\".votingItemBlockRow\" + $votingBlockId.val());\n                $votingItemBlockRow.removeClass('hidden');\n                if ($votingItemBlockRow.length > 0) {\n                    $votingItemBlockRow.removeClass('hidden');\n                    $votingItemBlockRow.find(\"select\").trigger('change'); // to trigger group name listener\n                } else {\n                    $(\".votingItemBlockNameRow\").addClass('hidden');\n                }\n            }\n        }).trigger('change');\n    }\n\n    private onSubmitDeleteForm(ev, data) {\n        if (data && typeof(data.confirmed) && data.confirmed === true) {\n            return;\n        }\n        ev.preventDefault();\n        bootbox.confirm(__t(\"admin\", \"delMotionConfirm\"), function (result) {\n            if (result) {\n                $(\".motionDeleteForm\").trigger(\"submit\", {'confirmed': true});\n            }\n        });\n    }\n\n    private initMotionTextEdit() {\n        $(\"#motionTextEditCaller\").addClass(\"hidden\");\n        $(\"#motionTextEditHolder\").removeClass(\"hidden\");\n        $(\".wysiwyg-textarea\").each(function () {\n            let $holder = $(this),\n                $textarea = $holder.find(\".texteditor\"),\n                ckeditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                editor = ckeditor.getEditor();\n\n            $textarea.parents(\"form\").on(\"submit\", () => {\n                $textarea.parent().find(\"textarea\").val(editor.getData());\n            });\n        });\n        this.$updateForm.append(\"<input type='hidden' name='edittext' value='1'>\");\n\n        if ($(\".checkAmendmentCollisions\").length > 0) {\n            $(\".wysiwyg-textarea .texteditor\").on(\"focus\", function () {\n                $(\".checkAmendmentCollisions\").show();\n                $(\".saveholder .save\").prop(\"disabled\", true).hide();\n            });\n            $(\".checkAmendmentCollisions\").show();\n            $(\".saveholder .save\").prop(\"disabled\", true).hide();\n        }\n    }\n\n    private loadAmendmentCollisions() {\n        let url = $(\".checkAmendmentCollisions\").data(\"url\"),\n            sections = {},\n            $holder = $(\".amendmentCollisionsHolder\");\n\n        $(\"#motionTextEditHolder\").children().each(function () {\n            let $this = $(this);\n            if ($this.hasClass(\"wysiwyg-textarea\")) {\n                let sectionId = $this.attr(\"id\").replace(\"section_holder_\", \"\");\n                sections[sectionId] = CKEDITOR.instances[$this.find(\".texteditor\").attr(\"id\")].getData();\n            }\n        });\n        $.post(url, {\n            'newSections': sections,\n            '_csrf': this.$updateForm.find('> input[name=_csrf]').val()\n        }, function (html) {\n            $holder.html(html);\n\n            if ($holder.find(\".amendmentOverrideBlock > .texteditor\").length > 0) {\n                $holder.find(\".amendmentOverrideBlock > .texteditor\").each(function () {\n                    new AntragsgruenEditor($(this).attr(\"id\"));\n                });\n                $(\".amendmentCollisionsHolder\").scrollintoview({top_offset: -50});\n            }\n\n            $(\".checkAmendmentCollisions\").hide();\n            $(\".saveholder .save\").prop(\"disabled\", false).show();\n\n        });\n    }\n}\n"]}