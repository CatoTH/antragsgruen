const STATUS_REFERRED=10,STATUS_VOTE=11,STATUS_OBSOLETED_BY_MOT=32,STATUS_OBSOLETED_BY_AMEND=22,STATUS_CUSTOM_STRING=23,STATUS_PROPOSED_MOVE_TO_OTHER_MOTION=28;export class ChangeProposedProcedure{constructor(t){this.$widget=t,this.savingComment=!1,this.initElements(),this.initOpener(),this.initStatusSetter(),this.initCommentForm(),this.initVotingBlock(),this.initExplanation(),this.initTags(),t.on("submit",t=>t.preventDefault()),this.setVotingBlockSettings()}initElements(){var t;this.$statusDetails=this.$widget.find(".statusDetails"),this.$visibilityInput=this.$widget.find("input[name=proposalVisible]"),this.$votingStatusInput=this.$widget.find("input[name=votingStatus]"),this.$votingBlockId=this.$widget.find("select[name=votingBlockId]"),this.$tagsSelect=this.$widget.find(".proposalTagsSelect"),this.$openerBtn=$(".proposedChangesOpener button"),this.context=this.$widget.data("context"),this.saveUrl=this.$widget.attr("action"),this.csrf=this.$widget.find("input[name=_csrf]").val(),this.version=null!==(t=this.$widget.data("proposal-id"))&&void 0!==t?t:null,this.isLatestVersion=this.$widget[0].classList.contains("latestVersion"),this.isNewVersion=this.$widget[0].classList.contains("new")}initOpener(){this.$openerBtn.on("click",()=>{this.$widget.removeClass("hidden"),this.$openerBtn.addClass("hidden"),localStorage.setItem("proposed_procedure_enabled","1")}),this.$widget.on("click",".closeBtn",()=>{this.$widget.addClass("hidden"),this.$openerBtn.removeClass("hidden"),localStorage.setItem("proposed_procedure_enabled","0")}),"1"===localStorage.getItem("proposed_procedure_enabled")?(this.$widget.removeClass("hidden"),this.$openerBtn.addClass("hidden")):this.$widget.addClass("hidden")}initTags(){const t=this.$tagsSelect;t.selectize({create:!0,plugins:["remove_button"],render:{option_create:(t,i)=>'<div class="create">'+__t("std","add_tag")+": <strong>"+i(t.input)+"</strong></div>"}}),t.on("change",()=>{this.$widget.addClass("isChanged")})}reinitAfterReload(){this.initElements(),this.statusChanged(),this.commentsScrollBottom(),this.initExplanation(),this.initTags(),this.$widget.find(".newBlock").addClass("hidden"),this.$widget.find(".notifyProposerSection").addClass("hidden"),this.$widget.find("#votingBlockId").trigger("change")}setGlobalProposedStr(t){$(".motionData .proposedStatusRow .str").html(t)}performCallWithReload(t){t.context=this.context,void 0===t.version&&(t.version=this.version),$.ajax({url:this.saveUrl,type:"POST",data:JSON.stringify(t),processData:!1,contentType:"application/json; charset=utf-8",dataType:"json",headers:{"X-CSRF-Token":this.csrf},success:t=>{if(t.redirectToUrl)window.location.href=t.redirectToUrl;else if(t.success){let i=$(t.html);this.$widget.children().remove(),this.$widget.append(i.children()),this.$widget.data("proposal-id",i.data("proposal-id")),this.reinitAfterReload(),this.$widget.addClass("showSaved").removeClass("isChanged"),t.proposalStr&&this.setGlobalProposedStr(t.proposalStr),window.setTimeout(()=>this.$widget.removeClass("showSaved"),2e3)}else t.message?alert(t.message):alert("An error occurred")}}).catch(function(t){try{const i=JSON.parse(t.responseText);i.message?alert(i.message):alert(t.responseText)}catch(i){alert(t.responseText)}})}notifyProposer(){const t=this.$widget.find("textarea[name=proposalNotificationText]").val(),i=this.$widget.find("input[name=proposalNotificationFrom]").val(),e=this.$widget.find("input[name=proposalNotificationReply]").val();this.performCallWithReload({notifyProposer:!0,text:t,fromName:i,replyTo:e})}setPropserHasAccepted(){const t=this.$widget.find(".setConfirmation").data("msg");bootbox.confirm(t,t=>{t&&this.performCallWithReload({setProposerHasAccepted:"1"})})}saveStatus(){const t=this.$tagsSelect[0];let i=this.$widget.find(".statusForm input[type=radio]:checked").val(),e=void 0===i?null:parseInt(i,10),s={setStatus:e,visible:this.$visibilityInput.prop("checked"),votingBlockId:this.$votingBlockId.val(),votingItemBlockName:this.$widget.find(".votingItemBlockNameRow input").val(),tags:t.selectize.items};10==e&&(s.proposalComment=this.$widget.find("input[name=referredTo]").val()),22==e&&(s.proposalComment=this.$widget.find("select[name=obsoletedByAmendment]").val()),32==e&&(s.proposalComment=this.$widget.find("select[name=obsoletedByMotion]").val()),28==e&&this.$widget.find("select[name=movedToOtherMotion]").length>0&&(s.proposalComment=this.$widget.find("select[name=movedToOtherMotion]").val()),23==e&&(s.proposalComment=this.$widget.find("input[name=statusCustomStr]").val()),11==e&&(s.votingStatus=this.$votingStatusInput.filter(":checked").val()),"NEW"==s.votingBlockId&&(s.votingBlockTitle=this.$widget.find("input[name=newBlockTitle]").val()),s.votingItemBlockId={},this.$widget.find(".votingItemBlockInput").each(function(t,i){const e=$(i);s.votingItemBlockId[e.data("voting-block")+""]=e.val()}),this.$widget.find("input[name=setPublicExplanation]").prop("checked")&&(s.proposalExplanation=this.$widget.find("textarea[name=proposalExplanation]").val()),this.$widget.find("input[name=newVersion][value=current]").prop("checked")&&(s.version=this.version),this.$widget.find("input[name=newVersion][value=new]").prop("checked")&&(s.version=null),this.performCallWithReload(s)}statusChanged(){let t=parseInt(this.$widget.find(".statusForm input[type=radio]:checked").val(),10);this.$statusDetails.addClass("hidden"),this.$statusDetails.filter(".status_"+t.toString(10)).removeClass("hidden"),this.isNewVersion&&this.$statusDetails.filter(".statusModifiedLink").addClass("hidden"),0===t?this.$widget.addClass("noStatus"):this.$widget.removeClass("noStatus")}initStatusSetter(){this.$widget.on("change",".statusForm input[type=radio]",(t,i)=>{$(t.currentTarget).prop("checked")&&(this.statusChanged(),i&&!0===i.init||this.$widget.addClass("isChanged"))}),this.$widget.find(".statusForm input[type=radio]").trigger("change",{init:!0}),this.$widget.on("change keyup","input, textarea",t=>{$(t.currentTarget).parents(".proposalCommentForm").length>0||this.$widget.addClass("isChanged")}),this.$widget.on("change","#obsoletedByAmendment",()=>{this.$widget.addClass("isChanged")}),this.$widget.on("change","#movedToOtherMotion",()=>{this.$widget.addClass("isChanged")}),this.$widget.on("click",".saving button",this.saveStatus.bind(this)),this.$widget.on("click",".notifyProposer",()=>{this.$widget.find(".notifyProposerSection").removeClass("hidden"),this.$widget.find(".notifyProposerSection").scrollintoview({top_offset:-50})}),this.$widget.on("click",".setConfirmation",this.setPropserHasAccepted.bind(this)),this.$widget.on("click",".sendAgain",()=>{this.$widget.find(".notifyProposerSection").removeClass("hidden"),this.$widget.find(".notifyProposerSection").scrollintoview({top_offset:-50})}),this.$widget.on("click","button[name=notificationSubmit]",this.notifyProposer.bind(this))}setVotingBlockSettings(){this.$widget.find(".votingItemBlockRow select").on("change",t=>{const i=$(t.currentTarget);if(i.val()){const t=i.find("option[value="+i.val()+"]").data("group-name");this.$widget.find(".votingItemBlockNameRow input").val(t),this.$widget.find(".votingItemBlockNameRow").removeClass("hidden")}else this.$widget.find(".votingItemBlockNameRow").addClass("hidden")}),"NEW"===this.$votingBlockId.val()?(this.$widget.find(".newBlock").removeClass("hidden"),this.$widget.find(".votingItemBlockRow").addClass("hidden"),this.$widget.find(".votingItemBlockNameRow").addClass("hidden")):(this.$widget.find(".newBlock").addClass("hidden"),this.$widget.find(".votingItemBlockRow").addClass("hidden"),this.$widget.find(".votingItemBlockRow"+this.$votingBlockId.val()).removeClass("hidden"),this.$widget.find(".votingItemBlockRow"+this.$votingBlockId.val()+" select").trigger("change",[{initialization:!0}]))}initVotingBlock(){this.$widget.on("change","#votingBlockId",()=>{this.$widget.addClass("isChanged"),this.setVotingBlockSettings()}),this.$widget.on("change",".votingItemBlockRow select",(t,i)=>{i&&i.initialization||this.$widget.addClass("isChanged")}),this.$widget.find(".newBlock").addClass("hidden")}initExplanation(){this.$widget.find("input[name=setPublicExplanation]").on("change",t=>{$(t.target).prop("checked")?this.$widget.find("section.publicExplanation").removeClass("hidden"):this.$widget.find("section.publicExplanation").addClass("hidden")}),this.$widget.find("input[name=setPublicExplanation]").prop("checked")?this.$widget.find("section.publicExplanation").removeClass("hidden"):this.$widget.find("section.publicExplanation").addClass("hidden")}commentsScrollBottom(){let t=this.$widget.find(".proposalCommentForm .commentList");t[0].scrollTop=t[0].scrollHeight}doSaveComment(){let t=this.$widget.find(".proposalCommentForm"),i=t.find(".commentList"),e=t.find("textarea").val();""==e||this.savingComment||(this.savingComment=!0,$.ajax({url:this.saveUrl,type:"POST",data:JSON.stringify({writeComment:e,version:this.version}),processData:!1,contentType:"application/json; charset=utf-8",dataType:"json",headers:{"X-CSRF-Token":this.csrf},success:e=>{if(e.success){let s="";e.comment.delLink&&(s='<button type="button" data-url="'+e.comment.delLink+'" class="btn-link delComment">',s+='<span class="glyphicon glyphicon-trash"></span></button>');let n=$('<li class="comment"><div class="header"><div class="date"></div>'+s+'<div class="name"></div></div><div class="comment"></div></li>');n.find(".date").text(e.comment.dateFormatted),n.find(".name").text(e.comment.username),n.find(".comment").text(e.comment.text),n.data("id",e.comment.id),i.append(n),t.find("textarea").val(""),i[0].scrollTop=i[0].scrollHeight,this.$widget.data("proposal-id",e.proposalId),this.version=e.proposalId}else alert("Could not save: "+JSON.stringify(e));this.savingComment=!1}}).catch(()=>{alert("Could not save"),this.savingComment=!1}))}delComment(t){$.post(t.find(".delComment").data("url"),{_csrf:this.csrf,id:t.data("id")},i=>{i.success?t.remove():alert("Error: "+i.error)})}initCommentForm(){this.$widget.on("click",".proposalCommentForm button",()=>{this.doSaveComment()}),this.$widget.on("click",".btnMaximizeComments",()=>{this.$widget[0].classList.contains("maximizedComments")?this.$widget[0].classList.remove("maximizedComments"):this.$widget[0].classList.add("maximizedComments")}),this.commentsScrollBottom(),this.$widget.on("keypress",".proposalCommentForm textarea",t=>{t.originalEvent.metaKey&&"Enter"===t.originalEvent.key&&this.doSaveComment()}),this.$widget.on("click",".delComment",t=>{this.delComment($(t.currentTarget).parents(".comment").first())})}}
//# sourceMappingURL=ChangeProposedProcedure.js.map
