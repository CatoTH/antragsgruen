{"version":3,"sources":["backend/AmendmentEditProposedChange.ts"],"names":["AmendmentEditProposedChange","$form","this","hasChanged","textEditCalled","initCollisionDetection","on","$","window","off","onLeavePage","prototype","_this","each","i","el","$textarea","find","ckeditor","AntragsgruenEditor_1","AntragsgruenEditor","attr","getEditor","parents","submit","parent","val","getData","plugins","lite","findPlugin","acceptAll","onContentChanged","bind","click","ev","$text","currentTarget","setData","data","addClass","$collisionIndicator","setInterval","sectionData","getTextConsolidatedSections","url","post","_csrf","sections","ret","length","removeClass","listHtml_1","forEach","html","$holder","sectionId","$cloned","clone","MotionMergeAmendments_1","MotionMergeChangeActions","insertAccept","deleteAccept","__t","hasClass","exports"],"mappings":"gLAGA,IAAAA,EAAA,WAII,SAAAA,EAA2BC,GAAAC,KAAAD,MAAAA,EAHnBC,KAAAC,YAAsB,EAI1BD,KAAKE,iBACLF,KAAKG,yBAELJ,EAAMK,GAAG,SAAU,WACfC,EAAEC,QAAQC,IAAI,eAAgBT,EAA4BU,eAyFtE,OArFYV,EAAAW,UAAAP,eAAR,WAAA,IAAAQ,EAAAV,KACIK,EAAE,kDAAkDM,KAAK,SAACC,EAAGC,GACzD,IACIC,EADUT,EAAEQ,GACQE,KAAK,eAGzBC,EAD6B,IAAIC,EAAAC,mBAAmBJ,EAAUK,KAAK,OAChCC,YAEvCN,EAAUO,QAAQ,QAAQC,OAAO,WAC7BR,EAAUS,SAASR,KAAK,gBAAgBS,IAAIR,EAASS,gBAChB,IAA1BT,EAASU,QAAY,OAC5BV,EAASU,QAAQC,KAAKC,WAAWZ,GAAUa,YAC3Cf,EAAUS,SAASR,KAAK,yBAAyBS,IAAIR,EAASS,cAKtEpB,EAAE,IAAMS,EAAUK,KAAK,OAAOf,GAAG,WAAYM,EAAKoB,iBAAiBC,KAAKrB,MAG5EV,KAAKD,MAAMgB,KAAK,cAAciB,MAAM,SAACC,GACjC,IAAIC,EAAgB7B,EAAE4B,EAAGE,eAAed,QAAQ,qBAAqBN,KAAK,eAC1ET,OAAiB,SAAa,UAAE4B,EAAMf,KAAK,OAAOiB,QAAQF,EAAMG,KAAK,kBAErEhC,EAAE4B,EAAGE,eAAed,QAAQ,oBAAoBiB,SAAS,aAIzDxC,EAAAW,UAAAN,uBAAR,WAAA,IAAAO,EAAAV,KACIA,KAAKuC,oBAAsBvC,KAAKD,MAAMgB,KAAK,uBAE3CT,OAAOkC,YAAY,WACf,IAAIC,EAAc/B,EAAKgC,8BACnBC,EAAMjC,EAAKX,MAAMsC,KAAK,uBAC1BhC,EAAEuC,KAAKD,EAAK,CACRE,MAASnC,EAAKX,MAAMgB,KAAK,uBAAuBS,MAChDsB,SAAYL,GACb,SAACM,GACA,GAAgC,GAA5BA,EAAgB,WAAEC,OAClBtC,EAAK6B,oBAAoBD,SAAS,cAC/B,CACH5B,EAAK6B,oBAAoBU,YAAY,UACrC,IAAIC,EAAW,GACfH,EAAgB,WAAEI,QAAQ,SAACtC,GACxBqC,GAAYrC,EAAS,OAExBH,EAAK6B,oBAAoBxB,KAAK,kBAAkBqC,KAAKF,OAI9D,MAGCpD,EAAAW,UAAAiC,4BAAR,WACI,IAAII,EAAW,GAgBf,OAfAzC,EAAE,mEAAmEM,KAAK,SAACC,EAAGC,GAC1E,IAAIwC,EAAUhD,EAAEQ,GACZC,EAAYuC,EAAQtC,KAAK,eACzBuC,EAAYD,EAAQhC,QAAQ,oBAAoBgB,KAAK,cAErDkB,EAAUzC,EAAU0C,OAAM,GAC9BD,EAAQxC,KAAK,YAAYJ,KAAK,SAACC,EAAGC,GAC9B4C,EAAAC,yBAAyBC,aAAa9C,KAE1C0C,EAAQxC,KAAK,YAAYJ,KAAK,SAACC,EAAGC,GAC9B4C,EAAAC,yBAAyBE,aAAa/C,KAG1CiC,EAASQ,GAAaC,EAAQH,SAE3BN,GAGGhD,EAAAU,YAAd,WACI,OAAOqD,IAAI,MAAO,uBAGf/D,EAAAW,UAAAqB,iBAAP,WACS9B,KAAKC,aACND,KAAKC,YAAa,EACbI,EAAE,QAAQyD,SAAS,YACpBzD,EAAEC,QAAQF,GAAG,eAAgBN,EAA4BU,eAIzEV,EAlGA,GAAaiE,EAAAjE,4BAAAA","file":"AmendmentEditProposedChange.js","sourcesContent":["import {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\nimport {MotionMergeChangeActions} from \"../frontend/MotionMergeAmendments\";\n\nexport class AmendmentEditProposedChange {\n    private hasChanged: boolean = false;\n    private $collisionIndicator: JQuery;\n\n    public constructor(private $form: JQuery) {\n        this.textEditCalled();\n        this.initCollisionDetection();\n\n        $form.on(\"submit\", () => {\n            $(window).off(\"beforeunload\", AmendmentEditProposedChange.onLeavePage);\n        });\n    }\n\n    private textEditCalled() {\n        $(\".wysiwyg-textarea:not(#sectionHolderEditorial)\").each((i, el) => {\n            let $holder = $(el),\n                $textarea = $holder.find(\".texteditor\");\n\n            let editor: AntragsgruenEditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                ckeditor: CKEDITOR.editor = editor.getEditor();\n\n            $textarea.parents(\"form\").submit(() => {\n                $textarea.parent().find(\"textarea.raw\").val(ckeditor.getData());\n                if (typeof(ckeditor.plugins.lite) != 'undefined') {\n                    ckeditor.plugins.lite.findPlugin(ckeditor).acceptAll();\n                    $textarea.parent().find(\"textarea.consolidated\").val(ckeditor.getData());\n                }\n            });\n\n            // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n            $('#' + $textarea.attr('id')).on('keypress', this.onContentChanged.bind(this));\n        });\n\n        this.$form.find('.resetText').click((ev) => {\n            let $text: JQuery = $(ev.currentTarget).parents('.wysiwyg-textarea').find('.texteditor');\n            window['CKEDITOR']['instances'][$text.attr('id')].setData($text.data('original-html'));\n\n            $(ev.currentTarget).parents('.modifiedActions').addClass('hidden');\n        });\n    }\n\n    private initCollisionDetection() {\n        this.$collisionIndicator = this.$form.find('#collisionIndicator');\n\n        window.setInterval(() => {\n            let sectionData = this.getTextConsolidatedSections();\n            let url = this.$form.data('collision-check-url');\n            $.post(url, {\n                '_csrf': this.$form.find('> input[name=_csrf]').val(),\n                'sections': sectionData\n            }, (ret) => {\n                if (ret['collisions'].length == 0) {\n                    this.$collisionIndicator.addClass('hidden');\n                } else {\n                    this.$collisionIndicator.removeClass('hidden');\n                    let listHtml = '';\n                    ret['collisions'].forEach((el) => {\n                       listHtml += el['html'];\n                    });\n                    this.$collisionIndicator.find('.collisionList').html(listHtml);\n                }\n            });\n\n        }, 5000);\n    }\n\n    private getTextConsolidatedSections() {\n        let sections = {};\n        $('.proposedVersion .wysiwyg-textarea:not(#sectionHolderEditorial)').each((i, el) => {\n            let $holder = $(el),\n                $textarea = $holder.find('.texteditor'),\n                sectionId = $holder.parents('.proposedVersion').data('section-id');\n\n            let $cloned = $textarea.clone(false);\n            $cloned.find('.ice-ins').each((i, el) => {\n                MotionMergeChangeActions.insertAccept(el);\n            });\n            $cloned.find('.ice-del').each((i, el) => {\n                MotionMergeChangeActions.deleteAccept(el);\n            });\n\n            sections[sectionId] = $cloned.html();\n        });\n        return sections;\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    public onContentChanged() {\n        if (!this.hasChanged) {\n            this.hasChanged = true;\n            if (!$(\"body\").hasClass('testing')) {\n                $(window).on(\"beforeunload\", AmendmentEditProposedChange.onLeavePage);\n            }\n        }\n    }\n}\n"]}