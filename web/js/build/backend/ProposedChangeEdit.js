import{AntragsgruenEditor}from"../shared/AntragsgruenEditor";import{MotionMergeChangeActions}from"../shared/MotionMergeChangeActions";export class ProposedChangeEdit{constructor(t){this.$form=t,this.hasChanged=!1,this.textEditCalled(),this.initCollisionDetection(),t.on("submit",()=>{$(window).off("beforeunload",ProposedChangeEdit.onLeavePage)})}textEditCalled(){$(".wysiwyg-textarea:not(#sectionHolderEditorial)").each((t,e)=>{let i=$(e).find(".texteditor"),n=new AntragsgruenEditor(i.attr("id")).getEditor();i.parents("form").on("submit",()=>{i.parent().find("textarea.raw").val(n.getData()),void 0!==n.plugins.lite&&(n.plugins.lite.findPlugin(n).acceptAll(),i.parent().find("textarea.consolidated").val(n.getData()))}),$("#"+i.attr("id")).on("keypress",this.onContentChanged.bind(this))}),this.$form.find(".resetText").on("click",t=>{let e=$(t.currentTarget).parents(".wysiwyg-textarea").find(".texteditor");window.CKEDITOR.instances[e.attr("id")].setData(e.data("original-html")),$(t.currentTarget).parents(".modifiedActions").addClass("hidden")})}initCollisionDetection(){if(!this.$form.data("collision-check-url"))return;this.$collisionIndicator=this.$form.find("#collisionIndicator");let t=null;window.setInterval(()=>{this.$form.find(".wysiwyg-textarea").find(".texteditor").each(function(){const t=$(this);window.CKEDITOR.instances[t.attr("id")].getData().replace(/\n/g,"")===t.data("original-html").replace(/\n/g,"","")?t.parents(".wysiwyg-textarea").find(".modifiedActions").addClass("hidden"):t.parents(".wysiwyg-textarea").find(".modifiedActions").removeClass("hidden")});let e=this.getTextConsolidatedSections();if(JSON.stringify(e)===t)return;t=JSON.stringify(e);let i=this.$form.data("collision-check-url");$.post(i,{_csrf:this.$form.find("> input[name=_csrf]").val(),sections:e},t=>{if(t.error)this.$collisionIndicator.removeClass("hidden"),this.$collisionIndicator.find(".collisionList").html("<li>"+t.error+"</li>");else if(0==t.collisions.length)this.$collisionIndicator.addClass("hidden");else{this.$collisionIndicator.removeClass("hidden");let e="";t.collisions.forEach(t=>{e+=t.html}),this.$collisionIndicator.find(".collisionList").html(e)}})},5e3)}getTextConsolidatedSections(){let t={};return $(".proposedVersion .wysiwyg-textarea:not(#sectionHolderEditorial)").each((e,i)=>{let n=$(i),o=n.find(".texteditor"),s=n.parents(".proposedVersion").data("section-id"),a=o.clone(!1);a.find(".ice-ins").each((t,e)=>{MotionMergeChangeActions.insertAccept(e)}),a.find(".ice-del").each((t,e)=>{MotionMergeChangeActions.deleteAccept(e,!1)}),t[s]=a.html()}),t}static onLeavePage(){return __t("std","leave_changed_page")}onContentChanged(){this.hasChanged||(this.hasChanged=!0,$("body").hasClass("testing")||$(window).on("beforeunload",ProposedChangeEdit.onLeavePage))}}
//# sourceMappingURL=ProposedChangeEdit.js.map
