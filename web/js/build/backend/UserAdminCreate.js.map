{"version":3,"sources":["backend/UserAdminCreate.ts"],"names":["UserAdminCreate","constructor","$el","this","lastGroupAssignmentWasAutomatical","element","initAddMultiple","initAddSingleInit","initAddSingleShow","querySelectorAll","forEach","openerEl","addEventListener","ev","type","currentTarget","getAttribute","el","classList","add","querySelector","remove","formEl","checkMultipleSubmit","bind","validateEmailText","text","indexOf","bootbox","alert","__t","samlLoginBtn","emailLoginBtn","hasEmailText","contains","value","preventDefault","emails","split","names","length","form","typeSelect","inputEmail","inputUsername","welcomeEmailHolder","required","stopPropagation","postData","_csrf","document","username","$","post","action","data","showAddSingleShowFromResponse","catch","err","responseText","response","authType","authUsername","alreadyMember","exists","organization","initOrganizationToUserGroup","removeAttribute","setAttribute","window","setTimeout","focus","setAutoOrganizations","selectedOrganization","autoUserGroups","organizationList","orga","name","input","checked","parseInt","defaultOrganisations","fixedOrganization","push","JSON","parse","$addSelect","selectize","create","render","option_create","escape","on","val","autoGeneratePassword","sendEmail","emailText","passwordInput","onAutoGeneratePasswordChanged","onSendEmailChanged"],"mappings":"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","file":"UserAdminCreate.js","sourcesContent":["type OrganizationEntry = {\n    name: string;\n    autoUserGroups: number[];\n}\n\ntype QueryUserResponse = {\n    exists: boolean;\n    alreadyMember?: boolean;\n    organization?: string;\n}\n\nexport class UserAdminCreate {\n    private element: HTMLElement;\n\n    constructor(private $el: JQuery) {\n        this.element = $el[0] as HTMLElement;\n\n        this.initAddMultiple();\n        this.initAddSingleInit();\n        this.initAddSingleShow();\n    }\n\n    private initAddMultiple() {\n        this.element.querySelectorAll(\".addMultipleOpener .addUsersOpener\").forEach(openerEl => {\n            openerEl.addEventListener('click', ev => {\n                const type = (ev.currentTarget as HTMLButtonElement).getAttribute('data-type');\n                this.element.querySelectorAll('.addUsersByLogin').forEach(el => {\n                    el.classList.add('hidden');\n                });\n                this.element.querySelector('.addUsersByLogin.' + type).classList.remove('hidden');\n            });\n        });\n\n        this.element.querySelectorAll('.addUsersByLogin.multiuser').forEach(formEl => {\n            formEl.addEventListener('submit', this.checkMultipleSubmit.bind(this));\n        });\n    }\n\n    private validateEmailText(text: string): boolean\n    {\n        if (text.indexOf(\"%ACCOUNT%\") === -1) {\n            bootbox.alert(__t(\"admin\", \"emailMissingCode\"));\n            return false;\n        }\n        if (text.indexOf(\"%LINK%\") === -1) {\n            bootbox.alert(__t(\"admin\", \"emailMissingLink\"));\n            return false;\n        }\n        return true;\n    }\n\n    private checkMultipleSubmit(ev: Event) {\n        const samlLoginBtn = this.element.querySelector(\".addUsersByLogin.samlWW\");\n        const emailLoginBtn = this.element.querySelector(\".addUsersByLogin.email\");\n        const hasEmailText = !!this.element.querySelector('#emailText'); // If e-mail-sending is deactivated, this will be false\n\n        if (emailLoginBtn && !emailLoginBtn.classList.contains('hidden')) {\n            if (hasEmailText) {\n                const text = (this.element.querySelector('#emailText') as HTMLTextAreaElement).value;\n                if (!this.validateEmailText(text)) {\n                    ev.preventDefault();\n                    return;\n                }\n            }\n\n            let emails = (this.element.querySelector(\"#emailAddresses\") as HTMLTextAreaElement).value.split(\"\\n\"),\n                names = (this.element.querySelector(\"#names\") as HTMLTextAreaElement).value.split(\"\\n\");\n            if (emails.length == 1 && emails[0] == \"\") {\n                ev.preventDefault();\n                bootbox.alert(__t(\"admin\", \"emailMissingTo\"));\n            }\n            if (emails.length != names.length) {\n                bootbox.alert(__t(\"admin\", \"emailNumberMismatch\"));\n                ev.preventDefault();\n            }\n        }\n        if (samlLoginBtn && !samlLoginBtn.classList.contains('hidden')) {\n            if ((this.element.querySelector(\"#samlWW\") as HTMLInputElement).value === \"\") {\n                ev.preventDefault();\n                bootbox.alert(__t(\"admin\", \"emailMissingUsername\"));\n            }\n        }\n    }\n\n    private initAddSingleInit() {\n        const form = this.element.querySelector('.addSingleInit') as HTMLFormElement,\n            typeSelect = this.element.querySelector('.adminTypeSelect') as HTMLSelectElement,\n            inputEmail = this.element.querySelector('.inputEmail') as HTMLInputElement,\n            inputUsername = this.element.querySelector('.inputUsername') as HTMLInputElement,\n            welcomeEmailHolder = this.element.querySelector('.welcomeEmail') as HTMLDivElement|null;\n\n        typeSelect.addEventListener('change', () => {\n            if (typeSelect.value === 'email') {\n                inputEmail.classList.remove('hidden');\n                inputUsername.classList.add('hidden');\n                inputEmail.required = true;\n                inputUsername.required = false;\n                if (welcomeEmailHolder) {\n                    welcomeEmailHolder.classList.remove('hidden');\n                }\n            } else {\n                if (welcomeEmailHolder) {\n                    welcomeEmailHolder.classList.add('hidden');\n                }\n\n                inputEmail.classList.add('hidden');\n                inputUsername.classList.remove('hidden');\n                inputEmail.required = false;\n                inputUsername.required = true;\n            }\n        });\n\n        form.addEventListener('submit', (ev: Event) => {\n            ev.preventDefault();\n            ev.stopPropagation();\n\n            const postData = {\n                _csrf: document.querySelector('head meta[name=csrf-token]').getAttribute('content'),\n                type: typeSelect.value,\n                username: ''\n            }\n            if (typeSelect.value === 'email') {\n                postData.username = inputEmail.value;\n            } else {\n                postData.username = inputUsername.value;\n            }\n\n            if (!postData.username) {\n                return;\n            }\n\n            $.post(form.action, postData, (data) => {\n                this.showAddSingleShowFromResponse(data, postData.type, postData.username);\n            }).catch(function (err) {\n                alert(err.responseText);\n            });\n        });\n    }\n\n    /**\n     * Functions that are to be called when showing the form\n     */\n    private showAddSingleShowFromResponse(response: QueryUserResponse, authType: string, authUsername: string)\n    {\n        const alreadyMember = this.element.querySelector('.alreadyMember') as HTMLDivElement;\n        const form = this.element.querySelector('.addUsersByLogin.singleuser') as HTMLFormElement;\n\n        if (response['exists'] && response['already_member']) {\n            alreadyMember.classList.remove('hidden');\n            form.classList.add('hidden');\n            return;\n        }\n\n        form.classList.remove('hidden');\n        alreadyMember.classList.add('hidden');\n\n        (this.element.querySelector('input[name=authType]') as HTMLInputElement).value = authType;\n        (this.element.querySelector('input[name=authUsername]') as HTMLInputElement).value = authUsername;\n\n        if (this.element.querySelector('#addSelectOrganization')) {\n            if (response.exists && response.organization) {\n                this.initOrganizationToUserGroup(response.organization);\n            } else {\n                this.initOrganizationToUserGroup(null);\n            }\n        }\n\n        if (response['exists']) {\n            form.querySelectorAll('.showIfNew').forEach(el => {\n                el.classList.add('hidden');\n            });\n\n            (form.querySelector('#addUserPassword') as HTMLInputElement).removeAttribute('required');\n        } else {\n            form.querySelectorAll('.showIfExists').forEach(el => {\n                el.classList.add('hidden');\n            });\n            (form.querySelector('#addSingleNameGiven') as HTMLInputElement).setAttribute('required', '');\n            (form.querySelector('#addSingleNameFamily') as HTMLInputElement).setAttribute('required', '');\n\n            window.setTimeout(() => {\n                (form.querySelector('input[name=nameGiven]') as HTMLInputElement).focus();\n            }, 1);\n        }\n    }\n\n    private organizationList: OrganizationEntry[];\n    private defaultOrganisations: number[];\n    private lastGroupAssignmentWasAutomatical: boolean = true;\n\n    private setAutoOrganizations(selectedOrganization: string): void\n    {\n        let autoUserGroups: number[] = [];\n        this.organizationList.forEach(orga => {\n            if (orga.name === selectedOrganization) {\n                autoUserGroups = orga.autoUserGroups;\n            }\n        });\n\n        // If it's an organisation with groups set, then set those groups.\n        // If no groups are assigned to this organisation, then reset the organisation IF no manual change has been made\n        if (autoUserGroups.length > 0) {\n            this.element.querySelectorAll('input.userGroup').forEach((input: HTMLInputElement) => {\n                input.checked = autoUserGroups.indexOf(parseInt(input.value, 10)) > -1;\n            });\n            this.lastGroupAssignmentWasAutomatical = true;\n        } else if (this.lastGroupAssignmentWasAutomatical) {\n            this.element.querySelectorAll('input.userGroup').forEach((input: HTMLInputElement) => {\n                input.checked = this.defaultOrganisations.indexOf(parseInt(input.value, 10)) > -1;\n            });\n        }\n    }\n\n    private initOrganizationToUserGroup(fixedOrganization: string|null)\n    {\n        this.defaultOrganisations = [];\n        this.element.querySelectorAll('input.userGroup').forEach((input: HTMLInputElement) => {\n            if (input.checked) this.defaultOrganisations.push(parseInt(input.value, 10));\n            input.addEventListener('change', () => this.lastGroupAssignmentWasAutomatical = false);\n        });\n        this.organizationList = JSON.parse(this.element.getAttribute('data-organisations')) as OrganizationEntry[];\n\n        if (fixedOrganization) {\n            this.setAutoOrganizations(fixedOrganization);\n        } else {\n            const $addSelect: any = $(\"#addSelectOrganization\");\n            $addSelect.selectize({\n                create: true,\n                render: {\n                    option_create: (data, escape) => {\n                        return '<div class=\"create\"><strong>' + escape(data.input) + '</strong></div>';\n                    }\n                }\n            });\n            $addSelect.on(\"change\", () => {\n                this.setAutoOrganizations($addSelect.val());\n            });\n        }\n    }\n\n    private initAddSingleShow()\n    {\n        const form = this.element.querySelector('.addUsersByLogin.singleuser') as HTMLFormElement,\n            autoGeneratePassword = form.querySelector('#addSingleGeneratePassword') as HTMLInputElement,\n            sendEmail = form.querySelector('#addSingleSendEmail') as HTMLInputElement,\n            emailText = form.querySelector('#addSingleEmailText') as HTMLTextAreaElement,\n            passwordInput = form.querySelector('#addUserPassword') as HTMLInputElement;\n\n        const onAutoGeneratePasswordChanged = () => {\n            if (autoGeneratePassword.checked) {\n                passwordInput.classList.add('hidden');\n                passwordInput.removeAttribute('required');\n            } else {\n                passwordInput.classList.remove('hidden');\n                passwordInput.setAttribute('required', '');\n            }\n        };\n        autoGeneratePassword.addEventListener('change', onAutoGeneratePasswordChanged);\n        onAutoGeneratePasswordChanged();\n\n        const onSendEmailChanged = () => {\n            if (sendEmail.checked) {\n                emailText.classList.remove('hidden');\n            } else {\n                emailText.classList.add('hidden');\n            }\n        };\n        sendEmail.addEventListener('change', onSendEmailChanged);\n        onSendEmailChanged();\n\n        form.addEventListener('submit', ev => {\n            if (sendEmail) {\n                const text = emailText.value;\n                if (!this.validateEmailText(text)) {\n                    ev.preventDefault();\n                    return;\n                }\n            }\n        });\n    }\n}\n"]}